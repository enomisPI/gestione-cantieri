<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestione Cantieri & Personale</title>
<style>
  body { font-family: Arial,sans-serif; margin:20px; background:#f9f9f9; }
  h1,h2 { color:#2c3e50; }
  .tabs { display:flex; gap:10px; margin-bottom:20px; }
  .tab { padding:10px 20px; background:#34495e; color:#fff; border-radius:4px 4px 0 0; cursor:pointer; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { display:none; background:#fff; padding:20px; border-radius:0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea, button { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
  select[multiple] { height:120px; }
  button { cursor:pointer; background:#3498db; color:#fff; border:none; border-radius:4px; }
  button:hover { background:#2980b9; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { border:1px solid #ccc; padding:8px; vertical-align:top; }
  th { background:#34495e; color:#fff; }
  .actions { white-space:nowrap; }
  .actions button { margin-left:4px; display:inline-block; }
  .interv-cell { display:flex; justify-content:space-between; align-items:center; }
  .interv-name { flex:1; margin-right:10px; }
  .filter { margin-bottom:10px; }
</style>
</head>
<body>

<h1>Gestione Cantieri & Personale</h1>
<div class="tabs">
  <div class="tab active" data-tab="cantieri">Cantieri</div>
  <div class="tab" data-tab="personale">Personale</div>
  <div class="tab" data-tab="pianificazione">Pianificazione</div>
</div>

<!-- CANTIERI -->
<div id="cantieri" class="content active">
  <h2>Cantieri</h2>
  <label>Nome cantiere</label>
  <input id="cantiereNome"><button id="cantiereSave">Salva</button>
  <label>Filtra</label><input id="cantiereFilter" class="filter" placeholder="Cerca...">
  <table><thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
    <tbody id="cantiereTbody"></tbody>
  </table>
</div>

<!-- PERSONALE -->
<div id="personale" class="content">
  <h2>Personale</h2>
  <label>Nome</label><input id="persNome">
  <label>Cognome</label><input id="persCog">
  <label>Mansione</label><input id="persMan">
  <label>Note</label><textarea id="persNote"></textarea>
  <button id="persSave">Salva</button>
  <label>Filtra (nome/cognome/mansione)</label><input id="persFilter" class="filter" placeholder="Cerca...">
  <table><thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
    <tbody id="persTbody"></tbody>
  </table>
</div>

<!-- PIANIFICAZIONE -->
<div id="pianificazione" class="content">
  <h2>Pianificazione</h2>
  <label>Data intervento</label><input type="date" id="planDate">
  <div id="planDateInfo" style="font-weight:bold;margin-top:6px;"></div>
  <label>Cantiere</label>
  <select id="planCant"><option value="">--- Seleziona ---</option></select>
  <label>Dipendenti</label>
  <select id="planPers" multiple disabled></select>
  <button id="planAdd">Assegna</button>
  <label>Note intervento</label><textarea id="planNote"></textarea>
  <table><thead><tr id="planHeader"><th>Data/Giorno</th></tr></thead>
    <tbody id="planBody"></tbody>
  </table>
</div>

<script>
(() => {
  // Dati in memoria
  let cantieri = [], persone = [], piani = [];
  let editCant = null, editPers = null, editPlan = null;

  // Elementi
  const tabs = document.querySelectorAll('.tab');
  const conts = document.querySelectorAll('.content');
  const $ = id => document.getElementById(id);

  // Utility date
  const giorni = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
  function fmtFull(d) {
    const dd=('0'+d.getDate()).slice(-2);
    const mm=('0'+(d.getMonth()+1)).slice(-2);
    return `${dd}/${mm}/${d.getFullYear()} ${giorni[d.getDay()]}`;
  }
  function iso(d){return d.toISOString().slice(0,10);}
  function getMonday(d){
    d=new Date(d);
    const day=d.getDay(), diff=(day===0? -6:1)-day;
    d.setDate(d.getDate()+diff);
    return d;
  }
  function weekDates(d){
    d=new Date(d);
    let m=getMonday(d), arr=[];
    for(let i=0;i<7;i++){ let x=new Date(m); x.setDate(m.getDate()+i); arr.push(x); }
    return arr;
  }

  // Tab switching
  tabs.forEach(tab=>{
    tab.onclick=()=>{
      tabs.forEach(t=>t.classList.remove('active'));
      conts.forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      $(tab.dataset.tab).classList.add('active');
    };
  });

  // --- CANTIERI ---
  function renderCantieri(){
    const f=$('cantiereFilter').value.toLowerCase();
    const tbody=$('cantiereTbody'); tbody.innerHTML='';
    cantieri.filter(c=>c.nome.toLowerCase().includes(f)).forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.nome}</td>
        <td class="actions">
          <button class="btn-edit">Modifica</button>
          <button class="btn-delete">Cancella</button>
        </td>`;
      // events
      tr.querySelector('.btn-delete').onclick=()=>{
        if(!confirm('Cancelli questo cantiere?')) return;
        cantieri = cantieri.filter(x=>x.id!==c.id);
        // rimuovi piani
        piani = piani.filter(p=>p.cantiere!==c.nome);
        renderCantieri();
        populateCantieri();
        renderPianificazione();
      };
      tr.querySelector('.btn-edit').onclick=()=>{
        editCant=c.id;
        $('cantiereNome').value=c.nome;
      };
      tbody.append(tr);
    });
  }
  $('cantiereSave').onclick=()=>{
    const v=$('cantiereNome').value.trim();
    if(!v) return alert('Nome obbligatorio');
    if(editCant){
      cantieri.find(c=>c.id===editCant).nome=v;
    } else {
      cantieri.push({id:Date.now(),nome:v});
    }
    editCant=null; $('cantiereNome').value='';
    renderCantieri(); populateCantieri();
  };
  $('cantiereFilter').oninput=renderCantieri;

  // --- PERSONALE ---
  function renderPers(){
    const f=$('persFilter').value.toLowerCase();
    const tbody=$('persTbody'); tbody.innerHTML='';
    persone.filter(p=>{
      const full=(p.n+' '+p.c).toLowerCase(), m=(p.m||'').toLowerCase();
      return full.includes(f)||p.c.toLowerCase().includes(f)||m.includes(f);
    }).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${p.n}</td><td>${p.c}</td><td>${p.m}</td><td>${p.note||''}</td>
        <td class="actions">
          <button class="btn-edit">Modifica</button>
          <button class="btn-delete">Cancella</button>
        </td>`;
      tr.querySelector('.btn-delete').onclick=()=>{
        if(!confirm('Cancelli questa persona?')) return;
        persone = persone.filter(x=>x.id!==p.id);
        // rimuovi piani
        piani = piani.filter(iv=>iv.idPersona!==p.id);
        renderPers();
        renderPianificazione();
      };
      tr.querySelector('.btn-edit').onclick=()=>{
        editPers=p.id;
        $('persNome').value=p.n;
        $('persCog').value=p.c;
        $('persMan').value=p.m;
        $('persNote').value=p.note;
      };
      tbody.append(tr);
    });
  }
  $('persSave').onclick=()=>{
    const n=$('persNome').value.trim(),
          c=$('persCog').value.trim();
    if(!n||!c) return alert('Nome e cognome obbligatori');
    const m=$('persMan').value.trim(),
          nt=$('persNote').value.trim();
    if(editPers){
      const p=persone.find(x=>x.id===editPers);
      p.n=n; p.c=c; p.m=m; p.note=nt;
    } else {
      persone.push({id:Date.now(),n,c,m,note:nt});
    }
    editPers=null;
    ['persNome','persCog','persMan','persNote'].forEach(id=>$(id).value='');
    renderPers();
    renderPianificazione();
  };
  $('persFilter').oninput=renderPers;

  // --- PIANIFICAZIONE ---
  function populateCantieri(){
    const sel=$('planCant');
    sel.innerHTML='<option value="">--- Seleziona ---</option>';
    cantieri.forEach(c=>sel.append(new Option(c.nome,c.nome)));
  }
  function aggiornaListPers(){
    const sel=$('planPers');
    sel.innerHTML='';
    sel.disabled = !$('planDate').value;
    if(!$('planDate').value) return;
    const assegnati = new Set(piani
      .filter(iv=>iv.data=== $('planDate').value)
      .map(iv=>iv.idPersona));
    persone.filter(p=>!assegnati.has(p.id))
      .forEach(p=> sel.append(new Option(p.n+' '+p.c,p.id)) );
  }
  $('planDate').onchange=()=>{
    $('planDateInfo').textContent = $('planDate').value
      ? fmtFull(new Date($('planDate').value+'T00:00:00'))
      : '';
    // non ricarico la lista qui
  };

  $('planAdd').onclick=()=>{
    const d=$('planDate').value, c=$('planCant').value;
    if(!d||!c) return alert('Data e cantiere obbligatori');
    const sel = Array.from($('planPers').selectedOptions)
                     .map(o=>o.value);
    if(editPlan){
      if(sel.length!==1) return alert('Modifica singolo intervento: seleziona 1');
      const iv = piani.find(x=>x.id===editPlan);
      iv.data=d; iv.cantiere=c; iv.idPersona=sel[0]; iv.note=$('planNote').value.trim();
    } else {
      sel.forEach(idp=>{
        if(!piani.find(iv=>iv.data===d && iv.cantiere===c && iv.idPersona===idp)){
          piani.push({
            id:Date.now()+Math.random(),
            data:d, cantiere:c, idPersona:idp,
            note:$('planNote').value.trim()
          });
        }
      });
    }
    editPlan=null; $('planNote').value='';
    aggiornaListPers(); renderPlan();
  };

  function renderPlan(){
    const tbody=$('planBody'), thead=$('planHeader');
    // clear cols
    thead.querySelectorAll('th:not(:first-child)').forEach(el=>el.remove());
    tbody.innerHTML='';
    if(!$('planDate').value) return;
    // settimana
    const base=new Date($('planDate').value+'T00:00:00'),
          sett=weekDates(base);
    // colonne usate
    const keys=sett.map(d=>iso(d)),
          cols=Array.from(new Set(piani
            .filter(iv=>keys.includes(iv.data))
            .map(iv=>iv.cantiere)))
            .sort();
    cols.forEach(c=>thead.append(new Element('th',{},c)));
    // righe
    sett.forEach(d=>{
      const tr=document.createElement('tr');
      const td0=document.createElement('td');
      td0.textContent=fmtFull(d);
      tr.append(td0);
      cols.forEach(c=>{
        const td=document.createElement('td');
        const ivs=piani.filter(iv=>iv.data===iso(d)&&iv.cantiere===c);
        if(ivs.length===0){
          td.textContent='-';
        } else {
          ivs.forEach(iv=>{
            const pers=persone.find(p=>p.id===iv.idPersona),
                  nome=pers? pers.n+' '+pers.c: '(sconosciuto)',
                  div=document.createElement('div');
            div.className='interv-cell';
            const span=document.createElement('span');
            span.className='interv-name';
            span.textContent=nome + (iv.note? ' – '+iv.note:'');
            const acts=document.createElement('div');
            acts.className='actions';
            const eb=document.createElement('button');
            eb.textContent='Modifica'; eb.className='btn-edit';
            eb.onclick=()=>{
              editPlan=iv.id;
              $('planDate').value=iv.data; $('planDate').dispatchEvent(new Event('change'));
              $('planCant').value=iv.cantiere;
              aggiornaListPers();
              $('planNote').value=iv.note;
              // imposta dipendente selezionato
              $('planPers').querySelectorAll('option').forEach(o=>o.selected=false);
              $('planPers').querySelector(`option[value="${iv.idPersona}"]`).selected=true;
            };
            const dbtn=document.createElement('button');
            dbtn.textContent='Cancella'; dbtn.className='btn-delete';
            dbtn.onclick=()=>{
              if(!confirm('Cancelli intervento?')) return;
              piani = piani.filter(x=>x.id!==iv.id);
              aggiornaListPers(); renderPlan();
            };
            acts.append(eb,dbtn);
            div.append(span,acts);
            td.append(div);
          });
        }
        tr.append(td);
      });
      tbody.append(tr);
    });
    // dopo render aggiorno la lista
    aggiornaListPers();
  }

  // Inizializzazione
  loadAll();
  function loadAll(){
    renderCantieri();
    renderPers();
    populateCantieri();
    renderPlan();
  }
})();
</script>
</body>
</html>
