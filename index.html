<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap:5px; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#f1c40f; }
  .btn-edit:hover { background:#d4ac0d; }
  .btn-delete { background:#e74c3c; }
  .btn-delete:hover { background:#c0392b; }
  td.date-cell { cursor:pointer; color:#2980b9; text-decoration: underline; }
  .week-display { font-style: italic; margin-top: 6px; }
  @media (max-width: 700px) { .tabs { flex-wrap: wrap; } }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" />
    <button id="btnSaveCant">Salva</button>

    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>

    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>
    <div id="dataPlanConGiorno" style="margin-top:6px; font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere">
      <option value="" disabled selected>-- Seleziona cantiere --</option>
    </select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <button id="btnAddPlan">Assegna</button>

    <table id="tablePlan">
      <thead>
        <tr>
          <th>Data</th>
          <!-- Colonne dinamiche cantieri qui -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportSettimana" style="margin-top: 10px;">Esporta pianificazione settimanale</button>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>

    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />

    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />

    <table id="tableAnnual">
      <thead>
        <tr>
          <th>Data</th>
          <!-- colonne dinamiche cantieri -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportAnnual" style="margin-top:10px;">Esporta settimana</button>
  </div>
</div>

<script>
(() => {
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cantieri = [];
  let persone = [];
  let piani = [];
  let editingCantId = null;
  let editingPersId = null;

  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if(tab.dataset.tab === 'pianificazione') initPlan();
      if(tab.dataset.tab === 'annuale') renderAnnual();
    });
  });

  async function caricaDati() {
    const cSnap = await db.collection('cantieri').get();
    cantieri = cSnap.docs.map(doc => ({ id: doc.id, nome: doc.data().nome }));
    renderCant(); populateCantieriSelect();

    const pSnap = await db.collection('persone').get();
    persone = pSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderPers(); updatePlanLists();

    const piSnap = await db.collection('piani').get();
    piani = piSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderPlan(); renderAnnual();
  }

  async function salvaCantiere(nome) {
    if (cantieri.some(c => c.nome === nome)) throw new Error("Cantiere già presente");
    if (editingCantId) {
      await db.collection('cantieri').doc(editingCantId).update({ nome });
      editingCantId = null;
      btnSaveCant.textContent = 'Salva';
    } else {
      await db.collection('cantieri').add({ nome });
    }
    inputCant.value = '';
    await caricaDati();
  }

  async function cancellaCantiere(id) {
    await db.collection('cantieri').doc(id).delete();
    const docs = await db.collection('piani').where('c', '==', cantieri.find(c=>c.id===id).nome).get();
    for(const d of docs.docs) await d.ref.delete();
    await caricaDati();
  }

  async function salvaPersona(persona) {
    if (!editingPersId && persone.find(p => p.n === persona.n && p.c === persona.c)) throw new Error("Persona già presente");
    if(editingPersId) {
      await db.collection('persone').doc(editingPersId).update(persona);
      editingPersId = null; btnSavePers.textContent = 'Salva';
    } else {
      await db.collection('persone').add(persona);
    }
    resetPersForm(); await caricaDati();
  }

  async function cancellaPersona(id) {
    await db.collection('persone').doc(id).delete();
    const docs = await db.collection('piani').get();
    for(const d of docs.docs) {
      const data = d.data();
      if(data.p.includes(id)) await d.ref.delete();
    }
    await caricaDati();
  }

  async function cancellaPianificazione(id) {
    await db.collection('piani').doc(id).delete();
    await caricaDati();
  }

  // Elementi Cantiere
  const inputCant = document.getElementById('nomeCantiere');
  const btnSaveCant = document.getElementById('btnSaveCant');
  btnSaveCant.onclick = async () => {
    const v = inputCant.value.trim(); if(!v) return alert('Inserisci nome cantiere');
    try { await salvaCantiere(v); } catch(e){ alert(e.message); }
  };

  function renderCant() {
    const tbody = document.querySelector('#tableCantieri tbody'); tbody.innerHTML='';
    cantieri.forEach(c => {
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.nome}</td><td><div class="btn-wrapper"></div></td>`;
      const wrap=tr.querySelector('.btn-wrapper');
      const edit=document.createElement('button'); edit.textContent='Modifica'; edit.className='btn-edit'; edit.onclick=()=>{
        inputCant.value=c.nome; editingCantId=c.id; btnSaveCant.textContent='Aggiorna';
      };
      const del=document.createElement('button'); del.textContent='Cancella'; del.className='btn-delete'; del.onclick=()=>{
        if(confirm('Confermi cancellazione?')) cancellaCantiere(c.id);
      };
      wrap.appendChild(edit); wrap.appendChild(del);
      tbody.appendChild(tr);
    });
  }

  // Personale
  const inputNomePers=document.getElementById('nomePersona');
  const inputCogPers=document.getElementById('cognomePersona');
  const inputMansione=document.getElementById('mansionePersona');
  const inputNotePers=document.getElementById('notePersona');
  const btnSavePers=document.getElementById('btnSavePers');
  btnSavePers.onclick=async()=>{
    const n=inputNomePers.value.trim(), c=inputCogPers.value.trim(); if(!n||!c) return alert('Inserisci nome e cognome');
    try{ await salvaPersona({ n,c, m:inputMansione.value.trim(), note:inputNotePers.value.trim() }); }catch(e){ alert(e.message);}  
  };

  function resetPersForm(){ inputNomePers.value=''; inputCogPers.value=''; inputMansione.value=''; inputNotePers.value=''; }

  function renderPers(){
    const tbody=document.querySelector('#tablePersonale tbody'); tbody.innerHTML='';
    persone.forEach(p=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.n}</td><td>${p.c}</td><td>${p.m||''}</td><td>${p.note||''}</td><td><div class="btn-wrapper"></div></td>`;
      const wrap=tr.querySelector('.btn-wrapper');
      const edit=document.createElement('button'); edit.textContent='Modifica'; edit.className='btn-edit'; edit.onclick=()=>{
        inputNomePers.value=p.n; inputCogPers.value=p.c; inputMansione.value=p.m||''; inputNotePers.value=p.note||'';
        editingPersId=p.id; btnSavePers.textContent='Aggiorna';
      };
      const del=document.createElement('button'); del.textContent='Cancella'; del.className='btn-delete'; del.onclick=()=>{ if(confirm('Confermi cancellazione?')) cancellaPersona(p.id); };
      wrap.appendChild(edit); wrap.appendChild(del);
      tbody.appendChild(tr);
    });
  }

  // Pianificazione
  const dataPlan=document.getElementById('dataPlan');
  const weekDisplay=document.getElementById('weekDisplay');
  const dataPlanConGiorno=document.getElementById('dataPlanConGiorno');
  const selectCantiere=document.getElementById('selectCantiere');
  const selectPers=document.getElementById('selectPers');
  const notePlan=document.getElementById('notePlan');
  const btnAddPlan=document.getElementById('btnAddPlan');

  btnAddPlan.onclick=async()=>{
    if(!dataPlan.value) return alert('Seleziona data');
    if(!selectCantiere.value) return alert('Seleziona cantiere');
    const sel=[...selectPers.selectedOptions].map(o=>o.value);
    if(sel.length===0) return alert('Seleziona almeno un dipendente');
    try{ await db.collection('piani').add({ d:dataPlan.value, c:selectCantiere.value, p:sel, n:notePlan.value.trim() });
      notePlan.value=''; initPlan(); caricaDati();
    }catch(e){ alert('Errore: '+e.message); }
  };

  function populateCantieriSelect(){
    selectCantiere.innerHTML='<option value="" disabled selected>-- Seleziona cantiere --</option>';
    cantieri.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; selectCantiere.appendChild(o); });
  }

  function updatePlanLists(){
    const usati=new Set();
    piani.filter(p=>p.d===dataPlan.value).forEach(p=>p.p.forEach(id=>usati.add(id)));
    selectPers.innerHTML='';
    persone.forEach(p=>{ if(!usati.has(p.id)){
      const o=document.createElement('option'); o.value=p.id; o.textContent=p.n+' '+p.c; selectPers.appendChild(o);
    }});
  }

  dataPlan.addEventListener('change',()=>{
    if(!dataPlan.value){ weekDisplay.textContent=''; dataPlanConGiorno.textContent=''; return; }
    const d=new Date(dataPlan.value);
    weekDisplay.textContent='Settimana: '+getWeek(d);
    dataPlanConGiorno.textContent='Giorno: '+nomeGiorno(d)+', '+formatDate(d);
    initPlan();
  });

  async function renderPlan(){
    const thRow=document.querySelector('#tablePlan thead tr'); thRow.innerHTML='<th>Data</th>';
    cantieri.forEach(c=> thRow.innerHTML+=`<th>${c.nome}</th>`);
    const tbody=document.querySelector('#tablePlan tbody'); tbody.innerHTML='';
    const gruppi={}; piani.forEach(p=>{ gruppi[p.d]??=[]; gruppi[p.d].push(p); });
    Object.keys(gruppi).sort().forEach(d=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${d}</td>`;
      cantieri.forEach(c=>{
        const cellPlans=gruppi[d].filter(p=>p.c===c.nome);
        if(cellPlans.length===0){ tr.innerHTML+='<td></td>'; }
        else{
          let txt=''; cellPlans.forEach(p=>{ const nomi=p.p.map(id=>{ const per=persone.find(x=>x.id===id); return per?per.n+' '+per.c:'???'; }); txt+=nomi.join(', ')+(p.n?` (${p.n})`:``)+` <button onclick=\"cancellaPianificazione('${p.id}')\">✖️</button><br>`; });
          tr.innerHTML+=`<td>${txt}</td>`;
        }
      });
      tbody.appendChild(tr);
    });
  }

  function initPlan(){ populateCantieriSelect(); updatePlanLists(); renderPlan(); }

  // Annuale
  const numWeekSelect=document.getElementById('numWeekSelect');
  const yearSelect=document.getElementById('yearSelect');
  function renderAnnual(){
    const w=parseInt(numWeekSelect.value), y=parseInt(yearSelect.value);
    const thRow=document.querySelector('#tableAnnual thead tr'); thRow.innerHTML='<th>Data</th>';
    cantieri.forEach(c=> thRow.innerHTML+=`<th>${c.nome}</th>`);
    const tbody=document.querySelector('#tableAnnual tbody'); tbody.innerHTML='';
    const start=getDateOfISOWeek(w,y);
    for(let i=0;i<7;i++){ const giorno=new Date(start); giorno.setDate(start.getDate()+i);
      const iso=giorno.toISOString().slice(0,10); const tr=document.createElement('tr'); tr.innerHTML=`<td>${formatDate(giorno)}</td>`;
      cantieri.forEach(c=>{
        const cell=piani.filter(p=>p.d===iso&&p.c===c.nome);
        if(cell.length===0) tr.innerHTML+='<td></td>';
        else{ let txt=''; cell.forEach(p=>{ const nomi=p.p.map(id=>{ const per=persone.find(x=>x.id===id); return per?per.n+' '+per.c:'???'; }); txt+=nomi.join(', ')+(p.n?` (${p.n})`:``)+`<br>`; }); tr.innerHTML+=`<td>${txt}</td>`; }
      }); tbody.appendChild(tr);
    }
  }
  numWeekSelect.addEventListener('change',renderAnnual);
  yearSelect.addEventListener('change',renderAnnual);

  // Utility date
  function getWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=t.getUTCDay()||7; t.setUTCDate(t.getUTCDate()+4-day); const ys=new Date(Date.UTC(t.getFullYear(),0,1)); return Math.ceil((((t-ys)/86400000)+1)/7); }
  function formatDate(d){ return ('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear(); }
  function nomeGiorno(d){ const g=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato']; return g[d.getDay()]; }
  function getDateOfISOWeek(w,y){ const simple=new Date(y,0,1+(w-1)*7); const dow=simple.getDay(); if(dow<=4) simple.setDate(simple.getDate()-simple.getDay()+1); else simple.setDate(simple.getDate()+8-simple.getDay()); return simple; }
  window.cancellaPianificazione = cancellaPianificazione;

  caricaDati();
})();
</script>

</body>
</html>
