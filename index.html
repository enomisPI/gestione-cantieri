<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#3498db; margin-right:5px; }
  .btn-edit:hover { background:#2980b9; }
  .btn-delete { background:#e74c3c; }
  .btn-delete:hover { background:#c0392b; }
  td.date-cell { cursor:pointer; color:#2980b9; text-decoration: underline; }
  .week-display { font-style: italic; margin-top: 6px; }
  @media (max-width: 700px) {
    .tabs { flex-wrap: wrap; }
  }
  /* Filtri di ricerca */
  #filterCantieri, #filterPersone {
    padding: 6px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" maxlength="50" />
    <button id="btnSaveCant">Salva</button>

    <label for="filterCantieri">Filtra cantieri</label>
    <input id="filterCantieri" placeholder="Cerca cantiere..." />

    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" maxlength="30" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" maxlength="30" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" maxlength="50" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>

    <label for="filterPersone">Filtra persone</label>
    <input id="filterPersone" placeholder="Cerca persona..." />

    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Seleziona data</label>
    <input type="date" id="dataPlan" />
    <div id="dataPlanConGiorno" style="margin-top:6px; font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere"></select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <button id="btnAddPlan" style="margin-bottom: 8px;">Assegna</button>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <table id="tablePlan" style="margin-top: 20px;">
      <thead>
        <tr id="tablePlanHeader">
          <th>Giorno/Data</th>
          <!-- Colonne cantieri dinamiche -->
        </tr>
      </thead>
      <tbody id="tablePlanBody"></tbody>
    </table>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>

    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />

    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />

    <table id="tableAnnual" style="margin-top: 15px;">
      <thead>
        <tr>
          <th>Data</th>
          <!-- colonne dinamiche cantieri -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };

  // Firebase init
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Dati locali
  let cantieri = [];
  let persone = [];
  let piani = [];

  // Editing state
  let editingCantId = null;
  let editingPersId = null;

  // Elementi DOM
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.content');

  // Cantieri
  const inputCant = document.getElementById('nomeCantiere');
  const btnSaveCant = document.getElementById('btnSaveCant');
  const tableCant = document.querySelector('#tableCantieri tbody');
  const filterCantieri = document.getElementById('filterCantieri');

  // Personale
  const inputNomePers = document.getElementById('nomePersona');
  const inputCogPers = document.getElementById('cognomePersona');
  const inputMansione = document.getElementById('mansionePersona');
  const inputNotePers = document.getElementById('notePersona');
  const btnSavePers = document.getElementById('btnSavePers');
  const tablePers = document.querySelector('#tablePersonale tbody');
  const filterPersone = document.getElementById('filterPersone');

  // Pianificazione
  const dataPlan = document.getElementById('dataPlan');
  const dataPlanConGiorno = document.getElementById('dataPlanConGiorno');
  const selectCantiere = document.getElementById('selectCantiere');
  const selectPers = document.getElementById('selectPers');
  const notePlan = document.getElementById('notePlan');
  const btnAddPlan = document.getElementById('btnAddPlan');
  const tablePlan = document.getElementById('tablePlan');
  const tablePlanBody = document.getElementById('tablePlanBody');
  const tablePlanHeader = document.getElementById('tablePlanHeader');

  // --- UTILI ---

  // Calcola lunedì della settimana della data
  function getMonday(d) {
    d = new Date(d);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day; // se domenica (0), torna indietro di 6
    d.setDate(d.getDate() + diff);
    return d;
  }

  // Restituisce array date lun-sab-dom della settimana di partenza
  function getWeekDates(baseDate) {
    const monday = getMonday(baseDate);
    const dates = [];
    for (let i=0; i<7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      dates.push(d);
    }
    return dates;
  }

  // Formatta data in gg/mm/aaaa NomeGiorno (nome giorno per esteso)
  function formatDateWithDay(d) {
    const giorni = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
    const gg = ('0' + d.getDate()).slice(-2);
    const mm = ('0' + (d.getMonth()+1)).slice(-2);
    const yyyy = d.getFullYear();
    return `${gg}/${mm}/${yyyy} ${giorni[d.getDay()]}`;
  }

  // Formatta data in ISO yyyy-mm-dd per input type=date
  function formatISODate(d) {
    return d.toISOString().slice(0,10);
  }

  // Aggiorna tabella cantieri con filtro
  function renderCant() {
    const filtro = filterCantieri.value.toLowerCase();
    tableCant.innerHTML = '';
    cantieri.filter(c => c.nome.toLowerCase().includes(filtro)).forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.nome}</td>
        <td>
          <button class="btn-edit" data-id="${c.id}" data-nome="${c.nome}">Modifica</button>
          <button class="btn-delete" data-id="${c.id}">Cancella</button>
        </td>
      `;
      tableCant.appendChild(tr);
    });

    // Eventi bottoni cancella
    tableCant.querySelectorAll('.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questo cantiere?')) {
          try {
            await db.collection('cantieri').doc(btn.dataset.id).delete();
            // Elimina piani legati
            const c = cantieri.find(x => x.id === btn.dataset.id);
            if(c){
              const pianiSnap = await db.collection('piani').where('c','==',c.nome).get();
              for(const doc of pianiSnap.docs) {
                await doc.ref.delete();
              }
            }
            await caricaDati();
          } catch(e) {
            alert('Errore cancellazione: ' + e.message);
          }
        }
      };
    });

    // Eventi bottoni modifica
    tableCant.querySelectorAll('.btn-edit').forEach(btn => {
      btn.onclick = () => {
        editingCantId = btn.dataset.id;
        inputCant.value = btn.dataset.nome;
        btnSaveCant.textContent = 'Aggiorna';
        switchTab('cantieri');
        inputCant.focus();
      };
    });
  }

  // Aggiorna tabella persone con filtro
  function renderPers() {
    const filtro = filterPersone.value.toLowerCase();
    tablePers.innerHTML = '';
    persone.filter(p => {
      const fullName = `${p.n} ${p.c}`.toLowerCase();
      return fullName.includes(filtro);
    }).forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.n}</td>
        <td>${p.c}</td>
        <td>${p.m}</td>
        <td>${p.note || ''}</td>
        <td>
          <button class="btn-edit" data-id="${p.id}" data-n="${p.n}" data-c="${p.c}" data-m="${p.m}" data-note="${p.note || ''}">Modifica</button>
          <button class="btn-delete" data-id="${p.id}">Cancella</button>
        </td>
      `;
      tablePers.appendChild(tr);
    });

    // Cancella persone
    tablePers.querySelectorAll('.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questa persona?')) {
          try {
            await db.collection('persone').doc(btn.dataset.id).delete();
            // Elimina piani legati
            const p = persone.find(x => x.id === btn.dataset.id);
            if(p){
              const pianiSnap = await db.collection('piani').where('idPersona','==',btn.dataset.id).get();
              for(const doc of pianiSnap.docs) {
                await doc.ref.delete();
              }
            }
            await caricaDati();
          } catch(e) {
            alert('Errore cancellazione: ' + e.message);
          }
        }
      };
    });

    // Modifica persone
    tablePers.querySelectorAll('.btn-edit').forEach(btn => {
      btn.onclick = () => {
        editingPersId = btn.dataset.id;
        inputNomePers.value = btn.dataset.n;
        inputCogPers.value = btn.dataset.c;
        inputMansione.value = btn.dataset.m;
        inputNotePers.value = btn.dataset.note;
        btnSavePers.textContent = 'Aggiorna';
        switchTab('personale');
        inputNomePers.focus();
      };
    });
  }

  // Salvataggio cantieri
  btnSaveCant.onclick = async () => {
    const nome = inputCant.value.trim();
    if(!nome) return alert('Inserisci nome cantiere');
    if(nome.length > 50) return alert('Nome troppo lungo');
    try {
      if(editingCantId){
        // Controllo duplicati
        if(cantieri.some(c => c.nome.toLowerCase() === nome.toLowerCase() && c.id !== editingCantId)){
          throw new Error('Cantiere già esistente');
        }
        await db.collection('cantieri').doc(editingCantId).update({nome});
        editingCantId = null;
        btnSaveCant.textContent = 'Salva';
      } else {
        if(cantieri.some(c => c.nome.toLowerCase() === nome.toLowerCase())){
          throw new Error('Cantiere già esistente');
        }
        await db.collection('cantieri').add({nome});
      }
      inputCant.value = '';
      await caricaDati();
    } catch(e) {
      alert(e.message);
    }
  };

  // Salvataggio persone
  btnSavePers.onclick = async () => {
    const n = inputNomePers.value.trim();
    const c = inputCogPers.value.trim();
    const m = inputMansione.value.trim();
    const note = inputNotePers.value.trim();
    if(!n || !c) return alert('Inserisci nome e cognome');
    if(n.length > 30 || c.length > 30) return alert('Nome o cognome troppo lungo (max 30)');
    if(m.length > 50) return alert('Mansione troppo lunga (max 50)');
    try {
      if(editingPersId){
        if(persone.some(p => p.n.toLowerCase() === n.toLowerCase() && p.c.toLowerCase() === c.toLowerCase() && p.id !== editingPersId)){
          throw new Error('Persona già esistente');
        }
        await db.collection('persone').doc(editingPersId).update({n, c, m, note});
        editingPersId = null;
        btnSavePers.textContent = 'Salva';
      } else {
        if(persone.some(p => p.n.toLowerCase() === n.toLowerCase() && p.c.toLowerCase() === c.toLowerCase())){
          throw new Error('Persona già esistente');
        }
        await db.collection('persone').add({n,c,m,note});
      }
      inputNomePers.value = '';
      inputCogPers.value = '';
      inputMansione.value = '';
      inputNotePers.value = '';
      await caricaDati();
    } catch(e) {
      alert(e.message);
    }
  };

  // Carica dati da Firebase
  async function caricaDati(){
    try {
      const cSnap = await db.collection('cantieri').get();
      cantieri = cSnap.docs.map(doc => ({id: doc.id, nome: doc.data().nome}));
      renderCant();
      popolaSelectCantieri();

      const pSnap = await db.collection('persone').get();
      persone = pSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPers();
      aggiornaSelectPers();

      const planSnap = await db.collection('piani').get();
      piani = planSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPianificazione();

    } catch(e) {
      alert('Errore caricamento dati: ' + e.message);
    }
  }

  // Cambio tab
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      switchTab(tab.dataset.tab);
    });
  });

  function switchTab(tabId){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
    contents.forEach(c => c.classList.toggle('active', c.id === tabId));
  }

  // Popola select cantieri
  function popolaSelectCantieri(){
    selectCantiere.innerHTML = '';
    cantieri.forEach(c => {
      const option = document.createElement('option');
      option.value = c.nome;
      option.textContent = c.nome;
      selectCantiere.appendChild(option);
    });
  }

  // Aggiorna select dipendenti per assegnazione (con filtro dinamico da escludere chi è già assegnato alla stessa data/cantiere)
  function aggiornaSelectPers() {
    const dataSelez = dataPlan.value;
    const cantiereSelez = selectCantiere.value;

    // Filtra persone non assegnate in quella data e cantiere
    let personeDisponibili = persone;
    if(dataSelez && cantiereSelez) {
      const assegnatiInDataCant = piani.filter(p => p.data === dataSelez && p.c === cantiereSelez).map(p => p.idPersona);
      personeDisponibili = persone.filter(p => !assegnatiInDataCant.includes(p.id));
    }

    // Aggiorna selectPers con personeDisponibili
    selectPers.innerHTML = '';
    personeDisponibili.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.n} ${p.c} (${p.m || '---'})`;
      selectPers.appendChild(option);
    });
  }

  // Aggiorna visualizzazione data selezionata con giorno scritto per esteso
  function aggiornaDataPlanConGiorno() {
    if(dataPlan.value) {
      const d = new Date(dataPlan.value + 'T00:00:00');
      dataPlanConGiorno.textContent = formatDateWithDay(d);
    } else {
      dataPlanConGiorno.textContent = '';
    }
  }

  // RENDER PIANIFICAZIONE
  // Mostra tutta la settimana della data selezionata (lun-dom)
  // Solo colonne cantieri usati nella settimana
  // Sotto ogni intervento tasto modifica + cancella
  async function renderPianificazione() {
    if(!dataPlan.value) {
      tablePlanBody.innerHTML = '';
      // Intestazione cantieri pulita
      tablePlanHeader.querySelectorAll('th:not(:first-child)').forEach(th => th.remove());
      return;
    }
    const baseDate = new Date(dataPlan.value + 'T00:00:00');
    const settimana = getWeekDates(baseDate);

    // Filtra piani per settimana (tutti i giorni della settimana)
    const dataSettimana = settimana.map(d => {
      return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;
    });

    // Trova tutti i cantieri usati in settimana nei piani
    let cantieriSettimana = new Set();
    piani.forEach(p => {
      if(dataSettimana.includes(p.data)) cantieriSettimana.add(p.c);
    });
    cantieriSettimana = Array.from(cantieriSettimana).sort();

    // Aggiorna intestazione tabella cantieri dinamicamente
    // Pulisce prima tutte colonne cantieri
    tablePlanHeader.querySelectorAll('th:not(:first-child)').forEach(th => th.remove());
    cantieriSettimana.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      tablePlanHeader.appendChild(th);
    });

    // Costruisci righe tabella: ogni riga = un giorno della settimana
    tablePlanBody.innerHTML = '';

    settimana.forEach(d => {
      const dataStr = formatISODate(d);
      const tr = document.createElement('tr');
      // Prima colonna: data + nome giorno per esteso
      tr.innerHTML = `<td>${formatDateWithDay(d)}</td>`;

      // Per ogni cantiere della settimana colonna interventi
      cantieriSettimana.forEach(c => {
        const td = document.createElement('td');
        // Filtra piani di quel giorno e cantiere
        const pianiInCell = piani.filter(p => p.data === dataStr && p.c === c);
        if(pianiInCell.length === 0) {
          td.textContent = '-';
        } else {
          pianiInCell.forEach(p => {
            // Trova persona per nome completo
            const persona = persone.find(per => per.id === p.idPersona);
            const nomePersona = persona ? `${persona.n} ${persona.c}` : '(sconosciuto)';
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.textContent = nomePersona + (p.note ? ' - ' + p.note : '');

            // Crea pulsanti Modifica e Cancella
            const btnEdit = document.createElement('button');
            btnEdit.textContent = 'Modifica';
            btnEdit.className = 'btn-edit';
            btnEdit.style.marginRight = '5px';
            btnEdit.onclick = () => {
              // Apri scheda pianificazione con dati piani precompilati per modifica
              // Popola campi
              dataPlan.value = p.data;
              aggiornaDataPlanConGiorno();
              selectCantiere.value = p.c;
              notePlan.value = p.note || '';
              // Seleziona solo quel dipendente (non tutti)
              selectPers.innerHTML = '';
              const opt = document.createElement('option');
              opt.value = p.idPersona;
              opt.textContent = nomePersona;
              opt.selected = true;
              selectPers.appendChild(opt);

              btnAddPlan.textContent = 'Aggiorna';
              editingPianificazioneId = p.id;

              switchTab('pianificazione');
            };

            const btnDelete = document.createElement('button');
            btnDelete.textContent = 'Cancella';
            btnDelete.className = 'btn-delete';
            btnDelete.onclick = async () => {
              if(confirm('Sei sicuro di cancellare questo intervento?')) {
                try {
                  await db.collection('piani').doc(p.id).delete();
                  await caricaDati();
                } catch(e) {
                  alert('Errore cancellazione intervento: ' + e.message);
                }
              }
            };

            div.appendChild(btnEdit);
            div.appendChild(btnDelete);
            td.appendChild(div);
          });
        }
        tr.appendChild(td);
      });
      tablePlanBody.appendChild(tr);
    });

    // Dopo render aggiorna lista dipendenti disponibile per la data/cantiere
    aggiornaSelectPers();
  }

  // Quando cambia data o cantiere aggiorna lista dipendenti disponibili
  dataPlan.addEventListener('change', () => {
    aggiornaDataPlanConGiorno();
    aggiornaSelectPers();
    renderPianificazione();
  });

  selectCantiere.addEventListener('change', () => {
    aggiornaSelectPers();
    renderPianificazione();
  });

  // Stato modifica pianificazione
  let editingPianificazioneId = null;

  // Aggiungi o aggiorna pianificazione
  btnAddPlan.onclick = async () => {
    const dataSel = dataPlan.value;
    const cantiereSel = selectCantiere.value;
    const personeSel = Array.from(selectPers.selectedOptions).map(o => o.value);
    const note = notePlan.value.trim();

    if(!dataSel || !cantiereSel) return alert('Seleziona data e cantiere');
    if(personeSel.length === 0) return alert('Seleziona almeno un dipendente');

    try {
      if(editingPianificazioneId){
        // Aggiorna un solo intervento, che ha una sola persona
        if(personeSel.length !== 1) {
          return alert('Modifica singolo intervento: seleziona un solo dipendente');
        }
        await db.collection('piani').doc(editingPianificazioneId).update({
          data: dataSel,
          c: cantiereSel,
          idPersona: personeSel[0],
          note
        });
        editingPianificazioneId = null;
        btnAddPlan.textContent = 'Assegna';
      } else {
        // Inserisci nuovi interventi, uno per ogni dipendente selezionato
        for(const idPers of personeSel) {
          // Controllo doppioni (non assegnare doppio stesso dipendente stesso giorno e cantiere)
          const doppio = piani.find(p => p.data === dataSel && p.c === cantiereSel && p.idPersona === idPers);
          if(doppio) continue;
          await db.collection('piani').add({
            data: dataSel,
            c: cantiereSel,
            idPersona: idPers,
            note
          });
        }
      }
      notePlan.value = '';
      selectPers.innerHTML = '';
      await caricaDati();
    } catch(e) {
      alert('Errore salvataggio pianificazione: ' + e.message);
    }
  };

  // Filtri ricerca
  filterCantieri.addEventListener('input', renderCant);
  filterPersone.addEventListener('input', renderPers);

  // Inizializza tutto al caricamento pagina
  caricaDati();

})();
</script>

</body>
</html>
