<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Cantieri e Personale</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    h1, h2 { color: #2c3e50; }
    .container { max-width: 1000px; margin: auto; }
    .tabs { display: flex; margin-bottom: 15px; }
    .tab { flex:1; text-align:center; padding:10px; background:#34495e; color:#fff; cursor:pointer; }
    .tab.active { background:#2c3e50; font-weight:bold; }
    .content { display:none; background:#fff; padding:20px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .content.active { display:block; }
    .form-group { margin-bottom:12px; }
    label { font-weight:bold; display:block; margin-bottom:6px; }
    input, select, textarea, button { width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#34495e; color:#fff; }
    .actions { display:flex; gap:6px; justify-content:flex-end; }
    .actions button { padding:4px 10px; font-size:0.9em; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <div class="form-group">
      <label for="nomeCantiere">Nome cantiere</label>
      <input id="nomeCantiere" placeholder="Inserisci nome cantiere">
    </div>
    <button id="saveCant">Salva</button>
    <table>
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody id="listCantieri"></tbody>
    </table>
  </div>

  <div id="personale" class="content">
    <h2>Personale</h2>
    <div class="form-group">
      <label for="nomePersona">Nome</label>
      <input id="nomePersona" placeholder="Nome">
    </div>
    <div class="form-group">
      <label for="cognomePersona">Cognome</label>
      <input id="cognomePersona" placeholder="Cognome">
    </div>
    <button id="savePers">Salva</button>
    <table>
      <thead><tr><th>Nome</th><th>Cognome</th><th>Azioni</th></tr></thead>
      <tbody id="listPers"></tbody>
    </table>
  </div>

  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <div class="form-group">
      <label for="planDate">Data</label>
      <input type="date" id="planDate">
    </div>
    <div class="form-group">
      <label for="planCant">Cantiere</label>
      <select id="planCant"><option value="" disabled selected>-- Seleziona --</option></select>
    </div>
    <div class="form-group">
      <label for="planPers">Dipendente</label>
      <select id="planPers"><option value="" disabled selected>-- Seleziona --</option></select>
    </div>
    <button id="addPlan">Assegna</button>
    <table>
      <thead><tr><th>Data</th><th>Cantiere</th><th>Dipendente</th><th>Azioni</th></tr></thead>
      <tbody id="listPlan"></tbody>
    </table>
  </div>

  <div id="annuale" class="content">
    <h2>Anteprima Annuale</h2>
    <div class="form-group">
      <label for="weekNum">Settimana #</label>
      <input type="number" id="weekNum" min="1" max="53" value="1">
    </div>
    <div class="form-group">
      <label for="yearNum">Anno</label>
      <input type="number" id="yearNum" min="2000" max="2100" value="2025">
    </div>
    <button id="showAnnual">Mostra</button>
    <table>
      <thead><tr><th>Giorno</th><th>Assegnazioni</th></tr></thead>
      <tbody id="listAnnual"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  // Inizializzazione Firebase
  firebase.initializeApp({
    apiKey: 'AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA',
    authDomain: 'gestione-cantieri-5c820.firebaseapp.com',
    projectId: 'gestione-cantieri-5c820'
  });
  const db = firebase.firestore();

  let cantieri = [], personale = [], piani = [];

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if (tab.dataset.tab === 'pianificazione') loadPianificazione();
    });
  });

  // Carica dati
  async function loadData() {
    const [cSnap, pSnap, planSnap] = await Promise.all([
      db.collection('cantieri').get(),
      db.collection('persone').get(),
      db.collection('piani').get()
    ]);
    cantieri = cSnap.docs.map(d => ({ id: d.id, nome: d.data().nome }));
    personale = pSnap.docs.map(d => ({ id: d.id, n: d.data().n, c: d.data().c }));
    piani = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCantieri();
    renderPersonale();
    loadPianificazione();
  }

  // Cantieri
  document.getElementById('saveCant').addEventListener('click', async () => {
    const nome = document.getElementById('nomeCantiere').value.trim();
    if (!nome) return;
    await db.collection('cantieri').add({ nome });
    document.getElementById('nomeCantiere').value = '';
    await loadData();
  });
  function renderCantieri() {
    const tbody = document.getElementById('listCantieri'); tbody.innerHTML = '';
    cantieri.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.nome}</td><td class="actions"><button onclick="deleteCantiere('${c.id}')">X</button></td>`;
      tbody.appendChild(tr);
    });
  }
  window.deleteCantiere = async (id) => { await db.collection('cantieri').doc(id).delete(); loadData(); };

  // Personale
  document.getElementById('savePers').addEventListener('click', async () => {
    const n = document.getElementById('nomePersona').value.trim();
    const c = document.getElementById('cognomePersona').value.trim();
    if (!n || !c) return;
    await db.collection('persone').add({ n, c });
    document.getElementById('nomePersona').value = '';
    document.getElementById('cognomePersona').value = '';
    await loadData();
  });
  function renderPersonale() {
    const tbody = document.getElementById('listPers'); tbody.innerHTML = '';
    personale.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.n}</td><td>${p.c}</td><td class="actions"><button onclick="deletePersona('${p.id}')">X</button></td>`;
      tbody.appendChild(tr);
    });
  }
  window.deletePersona = async (id) => { await db.collection('persone').doc(id).delete(); loadData(); };

  // Pianificazione
  async function loadPianificazione() {
    const date = document.getElementById('planDate').value;
    const selectCant = document.getElementById('planCant');
    selectCant.innerHTML = '<option value="" disabled selected>-- Seleziona --</option>' +
      cantieri.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
    const selectPers = document.getElementById('planPers');
    selectPers.innerHTML = '<option value="" disabled selected>-- Seleziona --</option>' +
      personale.map(p => `<option value="${p.id}">${p.n} ${p.c}</option>`).join('');
    const tbody = document.getElementById('listPlan'); tbody.innerHTML = '';
    piani.filter(pl => !date || pl.d === date).forEach(pl => {
      const u = personale.find(x => x.id === pl.p[0]);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${pl.d}</td><td>${pl.c}</td><td>${u? u.n+' '+u.c : ''}</td><td class="actions"><button onclick="deletePiano('${pl.id}')">X</button></td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('addPlan').addEventListener('click', async () => {
    const d = document.getElementById('planDate').value;
    const c = document.getElementById('planCant').value;
    const p = document.getElementById('planPers').value;
    if (!d || !c || !p) return;
    await db.collection('piani').add({ d, c, p: [p] });
    await loadData();
  });
  window.deletePiano = async (id) => { await db.collection('piani').doc(id).delete(); loadData(); };

  // Anteprima Annuale
  document.getElementById('showAnnual').addEventListener('click', () => {
    const w = parseInt(document.getElementById('weekNum').value);
    const y = parseInt(document.getElementById('yearNum').value);
    const tbody = document.getElementById('listAnnual'); tbody.innerHTML = '';
    if (isNaN(w) || isNaN(y)) return;
    let start = new Date(y, 0, 1 + (w-1) * 7);
    const dow = start.getDay() || 7;
    start.setDate(start.getDate() + (4 - dow));
    const yearStart = new Date(Date.UTC(start.getFullYear(),0,1));
    for (let i = 0; i < 7; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const iso = d.toISOString().substring(0,10);
      const entries = piani.filter(pl => pl.d === iso)
        .map(pl => pl.c + ': ' + (personale.find(x=>x.id===pl.p[0])?.n + ' ' + personale.find(x=>x.id===pl.p[0])?.c))
        .join('<br>');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${iso}</td><td>${entries}</td>`;
      tbody.appendChild(tr);
    }
  });

  // Inizializza
  loadData();
})();
</script>
</body>
</html>
