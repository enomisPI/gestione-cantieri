<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Cantieri e Personale</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    h1, h2 { color: #2c3e50; }
    .container { max-width: 1100px; margin: auto; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background: #34495e; color: #fff; padding: 10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; }
    .tab.active { background: #2c3e50; font-weight: bold; }
    .content { display: none; background: #fff; padding: 20px; border-radius: 0 4px 4px 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .content.active { display: block; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea, button { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
    select[multiple] { height: 130px; }
    button { background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: default; }
    button:hover:not(:disabled) { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #34495e; color: #fff; }
    .btn-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
    .btn-edit { background: #f1c40f; }
    .btn-delete { background: #e74c3c; }
    .small-btn { width: auto; margin: 2px 0; padding: 4px 8px; font-size: 0.9em; }
    .week-display { font-style: italic; margin-top: 6px; }
    @media(max-width:700px){ .tabs{ flex-wrap: wrap; } }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere">
    <button id="btnSaveCant">Salva</button>
    <table><thead><tr><th>Nome</th><th>Azioni</th></tr></thead><tbody id="tbodyCantieri"></tbody></table>
  </div>

  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label><input id="nomePersona" placeholder="Nome">
    <label for="cognomePersona">Cognome</label><input id="cognomePersona" placeholder="Cognome">
    <label for="mansionePersona">Mansione</label><input id="mansionePersona" placeholder="Mansione">
    <label for="notePersona">Note</label><textarea id="notePersona" rows="2"></textarea>
    <button id="btnSavePers">Salva</button>
    <table><thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead><tbody id="tbodyPers"></tbody></table>
  </div>

  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label><input type="date" id="dataPlan">
    <div class="week-display" id="weekDisplay"></div><div id="dataPlanConGiorno"></div>
    <label for="selectCantiere">Cantiere</label><select id="selectCantiere"><option value="" disabled selected>-- Seleziona --</option></select>
    <label for="selectPers">Dipendenti</label><select id="selectPers" multiple></select>
    <label for="notePlan">Note</label><textarea id="notePlan" rows="2"></textarea>
    <button id="btnAddPlan">Assegna</button>
    <button id="btnCancelEditPlan" style="display:none;">Annulla Modifica</button>
    <button id="btnExportSettimana">Esporta CSV Settimana</button>
    <table><thead><tr><th>Data</th><th>Cantiere</th><th>Dipendenti</th><th>Note</th><th>Azioni</th></tr></thead><tbody id="tbodyPlan"></tbody></table>
  </div>

  <div id="annuale" class="content">
    <h2>Anteprima Annuale</h2>
    <label for="numWeekSelect">Settimana #</label><input type="number" id="numWeekSelect" min="1" max="54" value="1">
    <label for="yearSelect">Anno</label><input type="number" id="yearSelect" min="2000" max="2100" value="2025">
    <button id="btnExportAnnual">Esporta CSV Annuale</button>
    <table><thead><tr><th>Data</th><th>Dettagli</th></tr></thead><tbody id="tbodyAnnual"></tbody></table>
  </div>
</div>
<script>
(() => {
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let cache = { cant: [], pers: [], plan: [] };
  let editing = { cant: null, pers: null, plan: null };

  async function caricaDati() {
    const [cantSnap, persSnap, planSnap] = await Promise.all([
      db.collection('cantieri').get(),
      db.collection('persone').get(),
      db.collection('piani').get()
    ]);
    cache.cant = cantSnap.docs.map(d => ({ id: d.id, nome: d.data().nome }));
    cache.pers = persSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    cache.plan = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCant(); renderPers(); prepPlan(); renderAnnual();
  }

  function switchTab(el) {
    document.querySelectorAll('.tab, .content').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    document.getElementById(el.dataset.tab).classList.add('active');
    if (el.dataset.tab === 'pianificazione') prepPlan();
    if (el.dataset.tab === 'annuale') renderAnnual();
  }
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t)));

  // Cantieri
  document.getElementById('btnSaveCant').addEventListener('click', async () => {
    const btn = document.getElementById('btnSaveCant'); btn.disabled = true;
    const nome = document.getElementById('nomeCantiere').value.trim(); if (!nome) { btn.disabled = false; return; }
    if (editing.cant) await db.collection('cantieri').doc(editing.cant).update({ nome });
    else await db.collection('cantieri').add({ nome });
    editing.cant = null; document.getElementById('nomeCantiere').value = '';
    btn.textContent = 'Salva'; await caricaDati(); btn.disabled = false;
  });
  function renderCant() {
    const tb = document.getElementById('tbodyCantieri'); tb.innerHTML = '';
    cache.cant.forEach(c => {
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${c.nome}</td><td><div class='btn-wrapper'></div></td>`;
      const w = tr.querySelector('.btn-wrapper');
      const e = document.createElement('button'); e.textContent = 'Modifica'; e.className = 'btn-edit small-btn'; e.onclick = () => {
        editing.cant = c.id; document.getElementById('nomeCantiere').value = c.nome;
        document.getElementById('btnSaveCant').textContent = 'Aggiorna';
      };
      const d = document.createElement('button'); d.textContent = 'Cancella'; d.className = 'btn-delete small-btn';
      d.onclick = async () => { if (confirm('Confermi?')) { await db.collection('cantieri').doc(c.id).delete(); await caricaDati(); } };
      w.append(e, d); tb.append(tr);
    });
  }

  // Personale
  document.getElementById('btnSavePers').addEventListener('click', async () => {
    const btn = document.getElementById('btnSavePers'); btn.disabled = true;
    const n = document.getElementById('nomePersona').value.trim(); const c = document.getElementById('cognomePersona').value.trim();
    if (!n || !c) { btn.disabled = false; return; }
    const data = { n, c, m: document.getElementById('mansionePersona').value.trim(), note: document.getElementById('notePersona').value.trim() };
    if (editing.pers) await db.collection('persone').doc(editing.pers).update(data);
    else await db.collection('persone').add(data);
    editing.pers = null; ['nomePersona','cognomePersona','mansionePersona','notePersona'].forEach(id => document.getElementById(id).value = '');
    btn.textContent = 'Salva'; await caricaDati(); btn.disabled = false;
  });
  function renderPers() {
    const tb = document.getElementById('tbodyPers'); tb.innerHTML = '';
    cache.pers.forEach(p => {
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.n}</td><td>${p.c}</td><td>${p.m||''}</td><td>${p.note||''}</td><td><div class='btn-wrapper'></div></td>`;
      const w = tr.querySelector('.btn-wrapper');
      const e = document.createElement('button'); e.textContent = 'Modifica'; e.className = 'btn-edit small-btn'; e.onclick = () => {
        editing.pers = p.id; document.getElementById('nomePersona').value = p.n;
        document.getElementById('cognomePersona').value = p.c; document.getElementById('mansionePersona').value = p.m;
        document.getElementById('notePersona').value = p.note; document.getElementById('btnSavePers').textContent = 'Aggiorna';
      };
      const d = document.createElement('button'); d.textContent = 'Cancella'; d.className = 'btn-delete small-btn';
      d.onclick = async () => { if (confirm('Confermi?')) { await db.collection('persone').doc(p.id).delete(); await caricaDati(); } };
      w.append(e, d); tb.append(tr);
    });
  }

  // Pianificazione
  document.getElementById('dataPlan').addEventListener('change', () => {
    const val = document.getElementById('dataPlan').value;
    if (val) {
      const d = new Date(val);
      document.getElementById('weekDisplay').textContent = 'Settimana: ' + getWeek(d);
      document.getElementById('dataPlanConGiorno').textContent = 'Giorno: ' + nomeGiorno(d) + ', ' + formatDate(d);
    } else { document.getElementById('weekDisplay').textContent = ''; document.getElementById('dataPlanConGiorno').textContent = ''; }
    prepPlan();
  });
  document.getElementById('btnAddPlan').addEventListener('click', async () => {
    const btn = document.getElementById('btnAddPlan'); btn.disabled = true;
    const d = document.getElementById('dataPlan').value; const c = document.getElementById('selectCantiere').value;
    const p = Array.from(document.getElementById('selectPers').selectedOptions).map(o => o.value);
    const n = document.getElementById('notePlan').value.trim(); if (!d || !c || p.length===0) { btn.disabled = false; return; }
    if (editing.plan) await db.collection('piani').doc(editing.plan).update({ d, c, p, n }); else await db.collection('piani').add({ d, c, p, n });
    editing.plan = null; document.getElementById('btnAddPlan').textContent='Assegna'; document.getElementById('btnCancelEditPlan').style.display='none';
    await prepPlan(); await caricaDati(); btn.disabled = false;
  });
  document.getElementById('btnCancelEditPlan').addEventListener('click', () => { editing.plan = null; document.getElementById('btnAddPlan').textContent = 'Assegna'; document.getElementById('btnCancelEditPlan').style.display = 'none'; prepPlan(); });

  function prepPlan() {
    const sc = document.getElementById('selectCantiere'); sc.innerHTML = '<option value="" disabled selected>-- Seleziona --</option>' + cache.cant.map(x => `<option value="${x.nome}">${x.nome}</option>`).join('');
    const used = new Set(cache.plan.filter(p => p.d === document.getElementById('dataPlan').value).flatMap(p => p.p));
    document.getElementById('selectPers').innerHTML = cache.pers.filter(x => !used.has(x.id)).map(x => `<option value="${x.id}">${x.n} ${x.c}</option>`).join('');
    renderPlan();
  }
  function renderPlan() {
    const tb = document.getElementById('tbodyPlan'); tb.innerHTML = '';
    cache.plan.sort((a,b) => a.d.localeCompare(b.d)).forEach(plan => {
      const dip = plan.p.map(id => { const u = cache.pers.find(pp => pp.id === id); return u ? u.n+' '+u.c : ''; }).join(', ');
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${plan.d}</td><td>${plan.c}</td><td>${dip}</td><td>${plan.n}</td><td><div class='btn-wrapper'></div></td>`;
      const w = tr.querySelector('.btn-wrapper');
      const e = document.createElement('button'); e.textContent = '✏️'; e.className='btn-edit small-btn'; e.onclick = () => {
        editing.plan = plan.id; document.getElementById('dataPlan').value = plan.d; document.getElementById('notePlan').value = plan.n;
        document.getElementById('btnAddPlan').textContent = 'Aggiorna'; document.getElementById('btnCancelEditPlan').style.display = 'block'; prepPlan();
        Array.from(document.getElementById('selectPers').options).forEach(o => o.selected = plan.p.includes(o.value));
      };
      const d = document.createElement('button'); d.textContent = '✖️'; d.className='btn-delete small-btn'; d.onclick = async () => { if (confirm('Confermi?')) { await db.collection('piani').doc(plan.id).delete(); await caricaDati(); } };
      w.append(e, d); tb.append(tr);
    });
  }

  // Export CSV
  document.getElementById('btnExportSettimana').addEventListener('click', () => {
    const rows = [['Data','Cantiere','Dipendenti','Note']];
    cache.plan.forEach(p => rows.push([p.d,p.c,p.p.map(id=>{const u=cache.pers.find(x=>x.id===id);return u?u.n+' '+u.c:'';}).join(', '),p.n]));
    downloadCSV(rows,'pianificazione_settimana.csv');
  });
  document.getElementById('btnExportAnnual').addEventListener('click', () => {
    const w = parseInt(document.getElementById('numWeekSelect').value), y = parseInt(document.getElementById('yearSelect').value);
    if(isNaN(w)||isNaN(y)) return; let date = new Date(y,0,1+(w-1)*7); const dow=date.getDay(); if(dow<=4) date.setDate(date.getDate()-dow+1); else date.setDate(date.getDate()+8-dow);
    const rows=[['Data','Dettagli']]; for(let i=0;i<7;i++){const d=new Date(date);d.setDate(date.getDate()+i);const iso=d.toISOString().slice(0,10);
      const det = cache.plan.filter(p=>p.d===iso).map(p=>p.c+': '+p.p.map(id=>{const u=cache.pers.find(x=>x.id===id);return u?u.n+' '+u.c:'';}).join(', ')).join(' | ');
      rows.push([iso,det]);}
    downloadCSV(rows,'anteprima_annuale.csv');
  });
  function downloadCSV(rows,fn){const csv=rows.map(r=>r.map(c=>`"${c.replace(/"/g,'""')}"`).join(',')).join('\n');const b=new Blob([csv],{type:'text/csv'});const l=document.createElement('a');l.href=URL.createObjectURL(b);l.setAttribute('download',fn);document.body.appendChild(l);l.click();document.body.removeChild(l);}  

  // Date utils
  function getWeek(d){const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const day=date.getUTCDay()||7;date.setUTCDate(date.getUTCDate()+4-day);const ys=new Date(Date.UTC(date.getUTCFullYear(),0,1));return Math.ceil((((date-ys)/86400000)+1)/7);}  
  function formatDate(d){return('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear();}
  function nomeGiorno(d){const g=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];return g[d.getDay()];}

  caricaDati();
})();
</script>
</body>
</html>
