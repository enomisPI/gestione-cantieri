<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#3498db; margin-right:5px; }
  .btn-delete { background:#e74c3c; }
  .btn-edit:hover { background:#2980b9; }
  .btn-delete:hover { background:#c0392b; }
  @media (max-width: 700px) { .tabs { flex-wrap: wrap; } }
  /* Filtri di ricerca */
  #filterCantieri, #filterPersone {
    padding: 6px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" maxlength="50" />
    <button id="btnSaveCant">Salva</button>
    <label for="filterCantieri">Filtra cantieri</label>
    <input id="filterCantieri" placeholder="Cerca cantiere..." />
    <table id="tableCantieri"><thead><tr><th>Nome</th><th>Azioni</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" maxlength="30" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" maxlength="30" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" maxlength="50" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>
    <label for="filterPersone">Filtra persone (nome, cognome, mansione)</label>
    <input id="filterPersone" placeholder="Cerca..." />
    <div id="infoRevisionePers" style="margin:10px 0;color:#e67e22;font-weight:bold;display:none;"></div>
    <table id="tablePersonale"><thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Seleziona data</label>
    <input type="date" id="dataPlan" />
    <div id="dataPlanConGiorno" style="margin-top:6px;font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere">
      <option value="">--- Seleziona cantiere ---</option>
    </select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <button id="btnAddPlan">Assegna</button>
    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <table id="tablePlan" style="margin-top:20px;">
      <thead><tr id="tablePlanHeader"><th>Giorno/Data</th></tr></thead>
      <tbody id="tablePlanBody"></tbody>
    </table>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale</h2>
    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />
    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />
    <table id="tableAnnual" style="margin-top:15px;">
      <thead><tr><th>Data</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Dati
  let cantieri = [], persone = [], piani = [];
  let editingCantId=null, editingPersId=null, editingPlanId=null;

  // Elementi
  const tabs=document.querySelectorAll('.tab'), contents=document.querySelectorAll('.content');
  const inputCant=document.getElementById('nomeCantiere'), btnSaveCant=document.getElementById('btnSaveCant');
  const filterCantieri=document.getElementById('filterCantieri'), tableCant=document.querySelector('#tableCantieri tbody');

  const inputNome=document.getElementById('nomePersona'), inputCog=document.getElementById('cognomePersona');
  const inputMan=document.getElementById('mansionePersona'), inputNote=document.getElementById('notePersona');
  const btnSavePers=document.getElementById('btnSavePers'), filterPers=document.getElementById('filterPersone');
  const infoRevPers=document.getElementById('infoRevisionePers'), tablePers=document.querySelector('#tablePersonale tbody');

  const dataPlan=document.getElementById('dataPlan'), dataPlanInfo=document.getElementById('dataPlanConGiorno');
  const selectCant=document.getElementById('selectCantiere'), selectPers=document.getElementById('selectPers');
  const notePlan=document.getElementById('notePlan'), btnAddPlan=document.getElementById('btnAddPlan');
  const tablePlanHead=document.getElementById('tablePlanHeader'), tablePlanBody=document.getElementById('tablePlanBody');

  // Utili
  function switchTab(id){
    tabs.forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
    contents.forEach(c=>c.classList.toggle('active',c.id===id));
  }
  tabs.forEach(t=>t.onclick=()=>switchTab(t.dataset.tab));

  const giorniSet=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
  function formatFull(d){
    const gg=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yyyy=d.getFullYear();
    return `${gg}/${mm}/${yyyy} ${giorniSet[d.getDay()]}`;
  }
  function iso(d){return d.toISOString().slice(0,10);}
  function getMonday(d){
    d=new Date(d); const day=d.getDay(), diff=(day===0? -6:1)-day; d.setDate(d.getDate()+diff); return d;
  }
  function weekDates(base){
    const m=getMonday(base), arr=[];
    for(let i=0;i<7;i++){const dd=new Date(m);dd.setDate(m.getDate()+i);arr.push(dd);}
    return arr;
  }

  // Caricamento dati
  async function carica(){
    const cSnap=await db.collection('cantieri').get();
    cantieri=cSnap.docs.map(d=>({id:d.id,nome:d.data().nome}));
    renderCant(); popolaCant();

    const pSnap=await db.collection('persone').get();
    persone=pSnap.docs.map(d=>({id:d.id,...d.data()}));
    renderPers(); aggiornaSelectPers();

    const planSnap=await db.collection('piani').get();
    piani=planSnap.docs.map(d=>({id:d.id,...d.data()}));
    renderPlan();
  }

  // Cantieri
  function renderCant(){
    const f=filterCantieri.value.toLowerCase();
    tableCant.innerHTML='';
    cantieri.filter(c=>c.nome.toLowerCase().includes(f)).forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.nome}</td>
        <td>
          <button class="btn-edit" data-id="${c.id}" data-nome="${c.nome}">Modifica</button>
          <button class="btn-delete" data-id="${c.id}">Cancella</button>
        </td>`;
      tableCant.appendChild(tr);
    });
    tableCant.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.onclick=async()=>{
        if(!confirm('Confermi cancellazione?')) return;
        await db.collection('cantieri').doc(btn.dataset.id).delete();
        const c=cantieri.find(x=>x.id===btn.dataset.id);
        if(c){
          const snap=await db.collection('piani').where('c','==',c.nome).get();
          for(const d of snap.docs) await d.ref.delete();
        }
        carica();
      };
    });
    tableCant.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.onclick=()=>{
        editingCantId=btn.dataset.id;
        inputCant.value=btn.dataset.nome;
        btnSaveCant.textContent='Aggiorna';
        switchTab('cantieri');
      };
    });
  }
  filterCantieri.oninput=renderCant;
  btnSaveCant.onclick=async()=>{
    const v=inputCant.value.trim();
    if(!v) return alert('Inserisci nome');
    if(editingCantId){
      if(cantieri.some(c=>c.nome.toLowerCase()===v.toLowerCase()&&c.id!==editingCantId)) return alert('Duplicato');
      await db.collection('cantieri').doc(editingCantId).update({nome:v});
    } else {
      if(cantieri.some(c=>c.nome.toLowerCase()===v.toLowerCase())) return alert('Duplicato');
      await db.collection('cantieri').add({nome:v});
    }
    editingCantId=null; btnSaveCant.textContent='Salva'; inputCant.value='';
    carica();
  };

  // Personale
  function renderPers(){
    const f=filterPers.value.toLowerCase();
    tablePers.innerHTML='';
    persone.filter(p=>{
      const full=(p.n+' '+p.c).toLowerCase(), mans=(p.m||'').toLowerCase();
      return full.includes(f)||p.c.toLowerCase().includes(f)||mans.includes(f);
    }).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${p.n}</td><td>${p.c}</td><td>${p.m}</td><td>${p.note||''}</td>
        <td>
          <button class="btn-edit" data-id="${p.id}" data-n="${p.n}" data-c="${p.c}" data-m="${p.m||''}" data-note="${p.note||''}">Modifica</button>
          <button class="btn-delete" data-id="${p.id}">Cancella</button>
        </td>`;
      tablePers.appendChild(tr);
    });
    tablePers.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.onclick=async()=>{
        if(!confirm('Confermi cancellazione persona?')) return;
        await db.collection('persone').doc(btn.dataset.id).delete();
        const snap=await db.collection('piani').where('idPersona','==',btn.dataset.id).get();
        for(const d of snap.docs) await d.ref.delete();
        carica();
      };
    });
    tablePers.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.onclick=()=>{
        editingPersId=btn.dataset.id;
        inputNome.value=btn.dataset.n; inputCog.value=btn.dataset.c;
        inputMan.value=btn.dataset.m; inputNote.value=btn.dataset.note;
        btnSavePers.textContent='Aggiorna';
        infoRevPers.style.display='block';
        infoRevPers.textContent=`Modifica persona: ${btn.dataset.n} ${btn.dataset.c}`;
        switchTab('personale');
      };
    });
  }
  filterPers.oninput=renderPers;
  btnSavePers.onclick=async()=>{
    const n=inputNome.value.trim(), c=inputCog.value.trim(), m=inputMan.value.trim(), nt=inputNote.value.trim();
    if(!n||!c) return alert('Nome e cognome obbligatori');
    if(editingPersId){
      if(persone.some(p=>p.n.toLowerCase()===n.toLowerCase()&&p.c.toLowerCase()===c.toLowerCase()&&p.id!==editingPersId)) return alert('Duplicato');
      await db.collection('persone').doc(editingPersId).update({n,c,m,note:nt});
    } else {
      if(persone.some(p=>p.n.toLowerCase()===n.toLowerCase()&&p.c.toLowerCase()===c.toLowerCase())) return alert('Duplicato');
      await db.collection('persone').add({n,c,m,note:nt});
    }
    editingPersId=null; btnSavePers.textContent='Salva';
    infoRevPers.style.display='none'; infoRevPers.textContent='';
    inputNome.value=''; inputCog.value=''; inputMan.value=''; inputNote.value='';
    carica();
  };

  // Pianificazione
  function popolaCant(){
    selectCant.innerHTML=`<option value="">--- Seleziona cantiere ---</option>`;
    cantieri.forEach(c=>{
      const o=new Option(c.nome,c.nome);
      selectCant.append(o);
    });
  }
  function aggiornaSelectPers(){
    selectPers.innerHTML='';
    const d=dataPlan.value;
    if(!d){ selectPers.disabled=true; return; }
    selectPers.disabled=false;
    // trova tutti i dipendenti già assegnati quel giorno (tutti cantieri)
    const es=new Set(piani.filter(p=>p.data===d).map(p=>p.idPersona));
    persone.filter(p=>!es.has(p.id)).forEach(p=>{
      const o=new Option(`${p.n} ${p.c}`,p.id);
      selectPers.append(o);
    });
  }
  function aggiornaDataInfo(){
    if(!dataPlan.value){ dataPlanInfo.textContent=''; return; }
    dataPlanInfo.textContent=formatFull(new Date(dataPlan.value+'T00:00:00'));
  }
  dataPlan.onchange=()=>{
    aggiornaDataInfo(); aggiornaSelectPers(); renderPlan();
  };
  selectCant.onchange=renderPlan;

  async function renderPlan(){
    if(!dataPlan.value){
      tablePlanHead.querySelectorAll('th:not(:first-child)').forEach(th=>th.remove());
      tablePlanBody.innerHTML=''; return;
    }
    const base=new Date(dataPlan.value+'T00:00:00');
    const sett=weekDates(base);
    const keys=sett.map(d=>iso(d));

    // colonne cantieri usati in settimana
    const cantUsati=new Set(piani.filter(p=>keys.includes(p.data)).map(p=>p.c));
    // ricostruisci header
    tablePlanHead.querySelectorAll('th:not(:first-child)').forEach(th=>th.remove());
    Array.from(cantUsati).sort().forEach(nome=>{
      const th=document.createElement('th'); th.textContent=nome;
      tablePlanHead.append(th);
    });

    // righe
    tablePlanBody.innerHTML='';
    sett.forEach(d=>{
      const row=document.createElement('tr');
      const td0=document.createElement('td'); td0.textContent=formatFull(d);
      row.append(td0);
      Array.from(cantUsati).sort().forEach(c=>{
        const td=document.createElement('td');
        const giornoKey=iso(d);
        const interventi=piani.filter(p=>p.data===giornoKey&&p.c===c);
        if(interventi.length===0){
          td.textContent='-';
        } else {
          interventi.forEach(iv=>{
            const pers=persone.find(x=>x.id===iv.idPersona);
            const nomePers=pers?`${pers.n} ${pers.c}`:'(sconosciuto)';
            const div=document.createElement('div'); div.style.marginBottom='4px';
            div.innerHTML=`<strong>${nomePers}</strong>${iv.note? ' - '+iv.note : ''}`;
            // Modifica
            const be=document.createElement('button');
            be.textContent='Modifica'; be.className='btn-edit'; be.style.marginRight='6px';
            be.onclick=()=>{
              editingPlanId=iv.id;
              dataPlan.value=iv.data; aggiornaDataInfo();
              selectCant.value=iv.c; aggiornaSelectPers();
              // popola selectPers solo con questo dipendente
              selectPers.innerHTML='';
              const op=new Option(nomePers,iv.idPersona,true,true);
              selectPers.append(op);
              notePlan.value=iv.note||'';
              btnAddPlan.textContent='Aggiorna';
              switchTab('pianificazione');
            };
            const bd=document.createElement('button');
            bd.textContent='Cancella'; bd.className='btn-delete';
            bd.onclick=async()=>{
              if(!confirm('Eliminare intervento?')) return;
              await db.collection('piani').doc(iv.id).delete();
              carica();
            };
            div.append(be,bd);
            td.append(div);
          });
        }
        row.append(td);
      });
      tablePlanBody.append(row);
    });
  }

  btnAddPlan.onclick=async()=>{
    const d=dataPlan.value, c=selectCant.value;
    const sel=Array.from(selectPers.selectedOptions).map(o=>o.value);
    const nt=notePlan.value.trim();
    if(!d||!c) return alert('Data e cantiere obbligatori');
    if(editingPlanId){
      if(sel.length!==1) return alert('Seleziona un solo dipendente');
      await db.collection('piani').doc(editingPlanId).update({data:d,c:id,c:id,idPersona:sel[0],note:nt});
      editingPlanId=null; btnAddPlan.textContent='Assegna';
    } else {
      for(const idp of sel){
        const doppio=piani.find(p=>p.data===d&&p.c===c&&p.idPersona===idp);
        if(!doppio) await db.collection('piani').add({data:d,c,idPersona:idp,note:nt});
      }
    }
    notePlan.value=''; await carica();
  };

  // Inizializza
  carica();
})();
</script>
</body>
</html>
