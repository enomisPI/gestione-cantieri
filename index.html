<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#3498db; margin-right:5px; }
  .btn-edit:hover { background:#2980b9; }
  .btn-delete { background:#e74c3c; }
  .btn-delete:hover { background:#c0392b; }
  td.date-cell { cursor:pointer; color:#2980b9; text-decoration: underline; }
  .week-display { font-style: italic; margin-top: 6px; }
  @media (max-width: 700px) {
    .tabs { flex-wrap: wrap; }
  }
  /* Filtri di ricerca */
  #filterCantieri, #filterPersone {
    padding: 6px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" maxlength="50" />
    <button id="btnSaveCant">Salva</button>

    <label for="filterCantieri">Filtra cantieri</label>
    <input id="filterCantieri" placeholder="Cerca cantiere..." />

    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" maxlength="30" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" maxlength="30" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" maxlength="50" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>

    <label for="filterPersone">Filtra persone</label>
    <input id="filterPersone" placeholder="Cerca persona..." />

    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>
    <div id="dataPlanConGiorno" style="margin-top:6px; font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere"></select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <button id="btnAddPlan" style="margin-bottom: 8px;">Assegna</button>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <table id="tablePlan" style="margin-top: 20px;">
      <thead>
        <tr>
          <th>Data</th>
          <!-- Colonne dinamiche cantieri qui -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportSettimana" style="margin-top: 10px;">Esporta pianificazione settimanale</button>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>

    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />

    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />

    <table id="tableAnnual" style="margin-top: 15px;">
      <thead>
        <tr>
          <th>Data</th>
          <!-- colonne dinamiche cantieri -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportAnnual" style="margin-top:10px;">Esporta settimana</button>
  </div>
</div>

<script>
(() => {
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Dati
  let cantieri = [];
  let persone = [];
  let piani = [];

  // Editing cantieri e persone
  let editingCantId = null;
  let editingPersId = null;

  // --- Elementi ---
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.content');

  const inputCant = document.getElementById('nomeCantiere');
  const btnSaveCant = document.getElementById('btnSaveCant');
  const tableCant = document.querySelector('#tableCantieri tbody');
  const filterCantieri = document.getElementById('filterCantieri');

  const inputNomePers = document.getElementById('nomePersona');
  const inputCogPers = document.getElementById('cognomePersona');
  const inputMansione = document.getElementById('mansionePersona');
  const inputNotePers = document.getElementById('notePersona');
  const btnSavePers = document.getElementById('btnSavePers');
  const tablePers = document.querySelector('#tablePersonale tbody');
  const filterPersone = document.getElementById('filterPersone');

  const dataPlan = document.getElementById('dataPlan');
  const weekDisplay = document.getElementById('weekDisplay');
  const dataPlanConGiorno = document.getElementById('dataPlanConGiorno');
  const selectCantiere = document.getElementById('selectCantiere');
  const selectPers = document.getElementById('selectPers');
  const notePlan = document.getElementById('notePlan');
  const btnAddPlan = document.getElementById('btnAddPlan');
  const tablePlan = document.getElementById('tablePlan');
  const tablePlanBody = tablePlan.querySelector('tbody');
  const tablePlanHead = tablePlan.querySelector('thead tr');

  const numWeekSelect = document.getElementById('numWeekSelect');
  const yearSelect = document.getElementById('yearSelect');
  const tableAnnual = document.getElementById('tableAnnual');
  const tableAnnualBody = tableAnnual.querySelector('tbody');
  const tableAnnualHead = tableAnnual.querySelector('thead tr');
  const btnExportSettimana = document.getElementById('btnExportSettimana');
  const btnExportAnnual = document.getElementById('btnExportAnnual');

  // --- FUNZIONI UTILI ---

  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }

  function getDateFromWeek(year, week, day=1) {
    // day = 1 lunedì, ... 7 domenica
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
      ISOweekStart.setDate(simple.getDate() - simple.getDay() + day);
    else
      ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay() + day);
    return ISOweekStart;
  }

  function formatDate(d) {
    return d.toISOString().split('T')[0];
  }

  function formatDateReadableWithDay(d) {
    // formato gg/mm/aaaa Lun.
    const giorniSettimana = ['Dom.', 'Lun.', 'Mar.', 'Mer.', 'Gio.', 'Ven.', 'Sab.'];
    const giornoAbbrev = giorniSettimana[d.getDay()];
    const gg = ('0' + d.getDate()).slice(-2);
    const mm = ('0' + (d.getMonth()+1)).slice(-2);
    const yyyy = d.getFullYear();
    return `${gg}/${mm}/${yyyy} ${giornoAbbrev}`;
  }

  // --- CARICAMENTO DATI ---
  async function caricaDati() {
    try {
      const cantiereSnap = await db.collection('cantieri').get();
      cantieri = cantiereSnap.docs.map(doc => ({id: doc.id, nome: doc.data().nome}));
      renderCant();
      populateCantieriSelect();

      const personeSnap = await db.collection('persone').get();
      persone = personeSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPers();
      updatePlanLists();

      const pianiSnap = await db.collection('piani').get();
      piani = pianiSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPlan();
      renderAnnual();
    } catch (e) {
      console.error('Errore caricamento dati:', e);
      alert('Errore caricamento dati: ' + e.message);
    }
  }

  // --- CANTIERI ---

  btnSaveCant.onclick = async () => {
    const val = inputCant.value.trim();
    if(!val) return alert('Inserisci nome cantiere');
    if(val.length > 50) return alert('Nome cantiere troppo lungo (max 50 caratteri)');
    try {
      if(editingCantId) {
        if(cantieri.find(c => c.nome.toLowerCase() === val.toLowerCase() && c.id !== editingCantId)) {
          throw new Error("Cantiere già presente con questo nome");
        }
        await db.collection('cantieri').doc(editingCantId).update({nome: val});
        editingCantId = null;
        btnSaveCant.textContent = 'Salva';
      } else {
        if(cantieri.find(c => c.nome.toLowerCase() === val.toLowerCase())) {
          throw new Error("Cantiere già presente");
        }
        await db.collection('cantieri').add({nome: val});
      }
      inputCant.value = '';
      await caricaDati();
    } catch(e) {
      alert(e.message);
    }
  };

  function renderCant() {
    const filtro = filterCantieri.value.toLowerCase();
    tableCant.innerHTML = '';
    cantieri.filter(c => c.nome.toLowerCase().includes(filtro)).forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.nome}</td>
        <td>
          <button class="btn-edit" data-id="${c.id}" data-nome="${c.nome}">Modifica</button>
          <button class="btn-delete" data-id="${c.id}">Cancella</button>
        </td>`;
      tableCant.appendChild(tr);
    });

    tableCant.querySelectorAll('button.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questo cantiere?')) {
          try {
            await db.collection('cantieri').doc(btn.dataset.id).delete();

            // Cancello tutte le pianificazioni di questo cantiere
            const cantiere = cantieri.find(c => c.id === btn.dataset.id);
            if (cantiere) {
              const pianiDocs = await db.collection('piani').where('c', '==', cantiere.nome).get();
              for (const doc of pianiDocs.docs) {
                await doc.ref.delete();
              }
            }
            await caricaDati();
          } catch (e) {
            alert('Errore cancellazione: ' + e.message);
          }
        }
      };
    });

    tableCant.querySelectorAll('button.btn-edit').forEach(btn => {
      btn.onclick = () => {
        editingCantId = btn.dataset.id;
        inputCant.value = btn.dataset.nome;
        btnSaveCant.textContent = 'Aggiorna';
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === 'cantieri'));
        contents.forEach(c => c.classList.toggle('active', c.id === 'cantieri'));
        inputCant.focus();
      };
    });
  }

  filterCantieri.addEventListener('input', renderCant);

  // --- PERSONALE ---

  btnSavePers.onclick = async () => {
    const n = inputNomePers.value.trim();
    const c = inputCogPers.value.trim();
    const m = inputMansione.value.trim();
    const note = inputNotePers.value.trim();
    if(!n || !c) return alert('Inserisci nome e cognome');
    if(n.length > 30 || c.length > 30) return alert('Nome o cognome troppo lungo (max 30 caratteri)');
    if(m.length > 50) return alert('Mansione troppo lunga (max 50 caratteri)');
    try {
      if(editingPersId) {
        if(persone.find(p => p.n.toLowerCase() === n.toLowerCase() && p.c.toLowerCase() === c.toLowerCase() && p.id !== editingPersId)) {
          throw new Error("Persona già presente con questo nome e cognome");
        }
        await db.collection('persone').doc(editingPersId).update({n, c, m, note});
        editingPersId = null;
        btnSavePers.textContent = 'Salva';
      } else {
        if(persone.find(p => p.n.toLowerCase() === n.toLowerCase() && p.c.toLowerCase() === c.toLowerCase())) {
          throw new Error("Persona già presente con questo nome e cognome");
        }
        await db.collection('persone').add({n, c, m, note});
      }
      inputNomePers.value = '';
      inputCogPers.value = '';
      inputMansione.value = '';
      inputNotePers.value = '';
      await caricaDati();
    } catch(e) {
      alert(e.message);
    }
  };

  function renderPers() {
    const filtro = filterPersone.value.toLowerCase();
    tablePers.innerHTML = '';
    persone.filter(p => {
      return p.n.toLowerCase().includes(filtro) || p.c.toLowerCase().includes(filtro) || (p.m && p.m.toLowerCase().includes(filtro));
    }).forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.n}</td><td>${p.c}</td><td>${p.m || ''}</td><td>${p.note || ''}</td>
        <td>
          <button class="btn-edit" data-id="${p.id}" data-n="${p.n}" data-c="${p.c}" data-m="${p.m || ''}" data-note="${p.note || ''}">Modifica</button>
          <button class="btn-delete" data-id="${p.id}">Cancella</button>
        </td>`;
      tablePers.appendChild(tr);
    });

    tablePers.querySelectorAll('button.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questa persona?')) {
          try {
            await db.collection('persone').doc(btn.dataset.id).delete();

            // Cancella pianificazioni dove presente questa persona
            const pianiDocs = await db.collection('piani').get();
            for(const doc of pianiDocs.docs) {
              const data = doc.data();
              if(data.p.includes(btn.dataset.id)) {
                await doc.ref.delete();
              }
            }
            await caricaDati();
          } catch(e) {
            alert('Errore cancellazione: ' + e.message);
          }
        }
      };
    });

    tablePers.querySelectorAll('button.btn-edit').forEach(btn => {
      btn.onclick = () => {
        editingPersId = btn.dataset.id;
        inputNomePers.value = btn.dataset.n;
        inputCogPers.value = btn.dataset.c;
        inputMansione.value = btn.dataset.m;
        inputNotePers.value = btn.dataset.note;
        btnSavePers.textContent = 'Aggiorna';
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === 'personale'));
        contents.forEach(c => c.classList.toggle('active', c.id === 'personale'));
        inputNomePers.focus();
      };
    });
  }

  filterPersone.addEventListener('input', renderPers);

  // --- PIANIFICAZIONE ---

  function populateCantieriSelect() {
    selectCantiere.innerHTML = '';
    cantieri.forEach(c => {
      const option = document.createElement('option');
      option.value = c.nome;
      option.textContent = c.nome;
      selectCantiere.appendChild(option);
    });
  }

  function updatePlanLists() {
    // Popolo lista dipendenti disponibili (non assegnati alla data e cantiere selezionata)
    aggiornaSelectPers();
  }

  // Funzione che aggiorna la lista dipendenti disponibili in base a data e cantiere
  function aggiornaSelectPers() {
    selectPers.innerHTML = '';

    const dataVal = dataPlan.value;
    const cantiereVal = selectCantiere.value;

    // Se manca data o cantiere, mostro tutta la lista
    if(!dataVal || !cantiereVal) {
      persone.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.n + ' ' + p.c;
        selectPers.appendChild(option);
      });
      return;
    }

    // Trovo persone già assegnate per quella data e cantiere
    const assegnati = new Set();
    piani.forEach(pl => {
      if(pl.d === dataVal && pl.c === cantiereVal) {
        pl.p.forEach(idp => assegnati.add(idp));
      }
    });

    persone.forEach(p => {
      if(!assegnati.has(p.id)) {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.n + ' ' + p.c;
        selectPers.appendChild(option);
      }
    });
  }

  dataPlan.onchange = () => {
    if(!dataPlan.value) {
      weekDisplay.textContent = '';
      dataPlanConGiorno.textContent = '';
      aggiornaSelectPers();
      return;
    }
    const d = new Date(dataPlan.value);
    const w = getWeekNumber(d);
    weekDisplay.textContent = `Settimana numero: ${w}`;

    // Mostro la data selezionata con giorno accanto
    dataPlanConGiorno.textContent = formatDateReadableWithDay(d);

    aggiornaSelectPers();
  };

  selectCantiere.onchange = () => {
    aggiornaSelectPers();
  };

  btnAddPlan.onclick = async () => {
    const dataVal = dataPlan.value;
    if(!dataVal) return alert('Seleziona la data dell\'intervento');
    const cantiereVal = selectCantiere.value;
    if(!cantiereVal) return alert('Seleziona un cantiere');
    const selectedPers = Array.from(selectPers.selectedOptions).map(opt => opt.value);
    if(selectedPers.length === 0) return alert('Seleziona almeno un dipendente');
    const noteVal = notePlan.value.trim();

    try {
      await db.collection('piani').add({
        d: dataVal,
        c: cantiereVal,
        p: selectedPers,
        note: noteVal
      });
      notePlan.value = '';
      selectPers.selectedIndex = -1;
      await caricaDati();

      // Dopo assegnazione aggiorno la lista dipendenti disponibili per questa data/cantiere (rimuovo appena assegnati)
      aggiornaSelectPers();

    } catch(e) {
      alert('Errore salvataggio pianificazione: ' + e.message);
    }
  };

  // Render tabella pianificazione
  function renderPlan() {
    // Prendo tutte le date distinte da piani e ordino
    const datesSet = new Set(piani.map(p => p.d));
    const dates = Array.from(datesSet).sort();

    // Per le colonne mostro solo cantieri usati in almeno una pianificazione esistente
    const cantieriUsatiSet = new Set(piani.map(p => p.c));
    const cantieriUsati = cantieri.filter(c => cantieriUsatiSet.has(c.nome));

    // Intestazione tabella
    tablePlanHead.innerHTML = '<th>Data</th>';
    cantieriUsati.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c.nome;
      tablePlanHead.appendChild(th);
    });

    // Corpo tabella
    tablePlanBody.innerHTML = '';

    dates.forEach(d => {
      const tr = document.createElement('tr');
      const dataObj = new Date(d);
      const dataTxt = formatDateReadableWithDay(dataObj);
      const tdData = document.createElement('td');
      tdData.textContent = dataTxt;
      tr.appendChild(tdData);

      cantieriUsati.forEach(c => {
        const td = document.createElement('td');
        td.style.maxWidth = '150px';

        // Trovo pianificazione con data=d e cantiere=c.nome
        const piano = piani.find(pl => pl.d === d && pl.c === c.nome);
        if(piano) {
          // Trovo nomi persone
          const nomiPersone = piano.p.map(idp => {
            const pers = persone.find(p => p.id === idp);
            return pers ? pers.n + ' ' + pers.c : '(non trovato)';
          }).join(', ');

          td.innerHTML = `
            <div><strong>${nomiPersone}</strong></div>
            <div>${piano.note || ''}</div>
            <button class="btn-delete" data-id="${piano.id}" style="margin-top:5px;">Cancella</button>
          `;

          td.querySelector('button').onclick = async () => {
            if(confirm('Cancellare questa pianificazione?')) {
              try {
                await db.collection('piani').doc(piano.id).delete();
                await caricaDati();
              } catch(e) {
                alert('Errore cancellazione: ' + e.message);
              }
            }
          };
        }
        tr.appendChild(td);
      });

      tablePlanBody.appendChild(tr);
    });
  }

  // --- ANNUALE ---

  function renderAnnual() {
    const weekNum = Number(numWeekSelect.value);
    const yearNum = Number(yearSelect.value);
    if(isNaN(weekNum) || isNaN(yearNum)) return;

    // Pulisco intestazione e corpo
    tableAnnualHead.innerHTML = '<th>Data</th>';

    // Trovo giorni della settimana da lunedì a domenica
    const giorniSettimana = [];
    for(let i=1; i<=7; i++) {
      const dd = getDateFromWeek(yearNum, weekNum, i);
      giorniSettimana.push(dd);
    }

    // Trovo cantieri usati in questa settimana (solo quelli con almeno una pianificazione)
    const nomiCantieriUsati = new Set();
    piani.forEach(pl => {
      const plDate = new Date(pl.d);
      if(plDate >= giorniSettimana[0] && plDate <= giorniSettimana[6]) {
        nomiCantieriUsati.add(pl.c);
      }
    });
    const cantieriUsati = cantieri.filter(c => nomiCantieriUsati.has(c.nome));

    // Creo intestazioni colonne cantieri usati
    cantieriUsati.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c.nome;
      tableAnnualHead.appendChild(th);
    });

    // Pulisco corpo tabella
    tableAnnualBody.innerHTML = '';

    // Creo 7 righe per la settimana
    giorniSettimana.forEach(dt => {
      const tr = document.createElement('tr');
      const strDate = formatDate(dt);
      const strDateLeggibile = formatDateReadableWithDay(dt);

      const tdData = document.createElement('td');
      tdData.textContent = strDateLeggibile;
      tr.appendChild(tdData);

      cantieriUsati.forEach(c => {
        const td = document.createElement('td');
        td.style.maxWidth = '150px';

        // Trovo eventuale pianificazione in data cantiere
        const piano = piani.find(pl => pl.d === strDate && pl.c === c.nome);
        if(piano) {
          const nomiPersone = piano.p.map(idp => {
            const pers = persone.find(p => p.id === idp);
            return pers ? pers.n + ' ' + pers.c : '(non trovato)';
          }).join(', ');

          td.innerHTML = `
            <div><strong>${nomiPersone}</strong></div>
            <div>${piano.note || ''}</div>
          `;
        }
        tr.appendChild(td);
      });

      tableAnnualBody.appendChild(tr);
    });
  }

  numWeekSelect.oninput = renderAnnual;
  yearSelect.oninput = renderAnnual;

  // --- EXPORT ---
  btnExportSettimana.onclick = () => {
    if(tablePlanBody.rows.length === 0) return alert('Nessuna pianificazione da esportare.');
    let csv = 'Data;';
    // Solo colonne cantieri usati
    const cantieriUsatiSet = new Set(piani.map(p => p.c));
    const cantieriUsati = cantieri.filter(c => cantieriUsatiSet.has(c.nome));
    cantieriUsati.forEach(c => { csv += `"${c.nome}";`; });
    csv += '\n';

    for(let row of tablePlanBody.rows) {
      let line = row.cells[0].textContent + ';';
      for(let i=1; i<row.cells.length; i++) {
        let txt = row.cells[i].textContent.replace(/;/g, ',');
        line += `"${txt}";`;
      }
      csv += line + '\n';
    }
    const nowStr = new Date().toISOString().slice(0,10);
    scaricaCSV(csv, `pianificazione_settimana_${nowStr}.csv`);
  };

  btnExportAnnual.onclick = () => {
    if(tableAnnualBody.rows.length === 0) return alert('Nessuna pianificazione da esportare.');
    let csv = 'Data;';
    // Colonne solo cantieri usati
    const weekNum = Number(numWeekSelect.value);
    const yearNum = Number(yearSelect.value);

    const giorniSettimana = [];
    for(let i=1; i<=7; i++) {
      const dd = getDateFromWeek(yearNum, weekNum, i);
      giorniSettimana.push(dd);
    }
    const nomiCantieriUsati = new Set();
    piani.forEach(pl => {
      const plDate = new Date(pl.d);
      if(plDate >= giorniSettimana[0] && plDate <= giorniSettimana[6]) {
        nomiCantieriUsati.add(pl.c);
      }
    });
    const cantieriUsati = cantieri.filter(c => nomiCantieriUsati.has(c.nome));
    cantieriUsati.forEach(c => { csv += `"${c.nome}";`; });
    csv += '\n';

    for(let row of tableAnnualBody.rows) {
      let line = row.cells[0].textContent + ';';
      for(let i=1; i<row.cells.length; i++) {
        let txt = row.cells[i].textContent.replace(/;/g, ',');
        line += `"${txt}";`;
      }
      csv += line + '\n';
    }
    scaricaCSV(csv, `pianificazione_settimana_${weekNum}_anno_${yearNum}.csv`);
  };

  function scaricaCSV(csv, filename) {
    const blob = new Blob([csv], {type: 'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // --- Gestione tabs ---
  tabs.forEach(tab => {
    tab.onclick = () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    };
  });

  // --- Inizializzazione ---
  caricaDati();

})();
</script>

</body>
</html>
