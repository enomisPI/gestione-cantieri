<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestione Cantieri e Personale</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .tabs { display:flex; gap:10px; margin-bottom:20px; }
  .tab { padding:10px 20px; background:#34495e; color:#fff; border-radius:4px 4px 0 0; cursor:pointer; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { display:none; background:#fff; padding:20px; border-radius:0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .content.active { display:block; }
  label { display:block; margin-top:10px; font-weight:bold; }
  input, select, textarea, button { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
  select[multiple] { height:120px; }
  button { background:#3498db; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { border:1px solid #ccc; padding:8px; vertical-align:top; }
  th { background:#34495e; color:#fff; }
  .actions { white-space:nowrap; text-align:right; }
  .actions button { margin-left:6px; }
  .interv-cell { display:flex; justify-content:space-between; align-items:center; }
  .interv-name { flex:1; }
  .filter { margin-bottom:10px; }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Gestione Cantieri e Personale</h1>
<div class="tabs">
  <div class="tab active" data-tab="cantieri">Cantieri</div>
  <div class="tab" data-tab="personale">Personale</div>
  <div class="tab" data-tab="pianificazione">Pianificazione</div>
</div>

<!-- Cantieri -->
<div id="cantieri" class="content active">
  <h2>Cantieri</h2>
  <label>Nome cantiere</label>
  <input id="nomeCantiere" placeholder="Inserisci nome cantiere" maxlength="50">
  <button id="salvaCantiere">Salva</button>
  <label>Filtra cantieri</label>
  <input id="filtroCantiere" class="filter" placeholder="Cerca...">
  <table>
    <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
    <tbody id="tbodyCantiere"></tbody>
  </table>
</div>

<!-- Personale -->
<div id="personale" class="content">
  <h2>Personale</h2>
  <label>Nome</label><input id="nomePersona" maxlength="30">
  <label>Cognome</label><input id="cognomePersona" maxlength="30">
  <label>Mansione</label><input id="mansionePersona" maxlength="50">
  <label>Note</label><textarea id="notePersona" rows="2"></textarea>
  <button id="salvaPersona">Salva</button>
  <label>Filtra persone (nome/cognome/mansione)</label>
  <input id="filtroPersona" class="filter" placeholder="Cerca...">
  <table>
    <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
    <tbody id="tbodyPersona"></tbody>
  </table>
</div>

<!-- Pianificazione -->
<div id="pianificazione" class="content">
  <h2>Pianificazione</h2>
  <label>Data intervento</label><input type="date" id="dataPlan">
  <div id="infoData" style="margin-top:6px;font-weight:bold;"></div>
  <label>Cantiere</label>
  <select id="selCantiere"><option value="">--- Seleziona ---</option></select>
  <label>Dipendenti</label>
  <select id="selPersona" multiple disabled></select>
  <button id="assegna">Assegna</button>
  <label>Note intervento</label><textarea id="notePlan" rows="2"></textarea>
  <table>
    <thead><tr id="planHeader"><th>Data/Giorno</th></tr></thead>
    <tbody id="planBody"></tbody>
  </table>
</div>

<script>
(() => {
  // Inizializza Firebase
  const cfg = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
  };
  firebase.initializeApp(cfg);
  const db = firebase.firestore();

  // Stato
  let cantieri = [], persone = [], piani = [], editingPlan = null;

  // DOM
  const $ = id=>document.getElementById(id);
  const tabs = document.querySelectorAll('.tab');
  const conts = document.querySelectorAll('.content');

  // Utils data
  const giorni = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
  function fmtFull(d){
    const gg=('0'+d.getDate()).slice(-2),
          mm=('0'+(d.getMonth()+1)).slice(-2),
          aa=d.getFullYear();
    return `${gg}/${mm}/${aa} ${giorni[d.getDay()]}`;
  }
  function iso(d){return d.toISOString().slice(0,10);}
  function getMonday(d){
    d=new Date(d);
    const day=d.getDay(), diff=(day===0? -6:1)-day;
    d.setDate(d.getDate()+diff);return d;
  }
  function weekDates(d){
    d=new Date(d);let m=getMonday(d), arr=[];
    for(let i=0;i<7;i++){let x=new Date(m);x.setDate(m.getDate()+i);arr.push(x);}
    return arr;
  }

  // Tab
  tabs.forEach(tab=>tab.onclick=()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    conts.forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    $(tab.dataset.tab).classList.add('active');
  });

  // Carica dati
  async function load(){
    const cs = await db.collection('cantieri').get();
    cantieri = cs.docs.map(d=>({id:d.id,nome:d.data().nome}));
    const ps = await db.collection('persone').get();
    persone = ps.docs.map(d=>({id:d.id,...d.data()}));
    const cis = await db.collection('piani').get();
    piani = cis.docs.map(d=>({id:d.id,...d.data()}));
    renderCantieri();
    renderPersone();
    populateCantieri();
    renderPianificazione();
  }

  // --- Cantieri ---
  function renderCantieri(){
    const f=$('filtroCantiere').value.toLowerCase();
    const tb=$('tbodyCantiere');tb.innerHTML='';
    cantieri.filter(c=>c.nome.toLowerCase().includes(f)).forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.nome}</td>
        <td class="actions">
          <button data-id="${c.id}" class="editC">Modifica</button>
          <button data-id="${c.id}" class="delC">Cancella</button>
        </td>`;
      tr.querySelector('.delC').onclick=async ()=>{
        if(!confirm('Cancelli?')) return;
        await db.collection('cantieri').doc(c.id).delete();
        // rimuovi piani correlati
        const snap=await db.collection('piani').where('c','==',c.nome).get();
        snap.forEach(d=>d.ref.delete());
        load();
      };
      tr.querySelector('.editC').onclick=()=>{
        $('nomeCantiere').value=c.nome;
        $('salvaCantiere').dataset.edit=c.id;
      };
      tb.append(tr);
    });
  }
  $('filtroCantiere').oninput=renderCantieri;
  $('salvaCantiere').onclick=async ()=>{
    const v=$('nomeCantiere').value.trim();
    if(!v) return alert('Nome richiesto');
    const edit=$('salvaCantiere').dataset.edit;
    if(edit){
      await db.collection('cantieri').doc(edit).update({nome:v});
      delete $('salvaCantiere').dataset.edit;
    } else {
      await db.collection('cantieri').add({nome:v});
    }
    $('nomeCantiere').value=''; load();
  };

  // --- Persone ---
  function renderPersone(){
    const f=$('filtroPersona').value.toLowerCase();
    const tb=$('tbodyPersona');tb.innerHTML='';
    persone.filter(p=>{
      const full=(p.n+' '+p.c).toLowerCase(), m=(p.m||'').toLowerCase();
      return full.includes(f)||p.c.toLowerCase().includes(f)||m.includes(f);
    }).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.n}</td><td>${p.c}</td><td>${p.m}</td><td>${p.note||''}</td>
        <td class="actions">
          <button data-id="${p.id}" class="editP">Modifica</button>
          <button data-id="${p.id}" class="delP">Cancella</button>
        </td>`;
      tr.querySelector('.delP').onclick=async()=>{
        if(!confirm('Cancelli?'))return;
        await db.collection('persone').doc(p.id).delete();
        const snap=await db.collection('piani').where('idPersona','==',p.id).get();
        snap.forEach(d=>d.ref.delete());
        load();
      };
      tr.querySelector('.editP').onclick=()=>{
        $('nomePersona').value=p.n;
        $('cognomePersona').value=p.c;
        $('mansionePersona').value=p.m;
        $('notePersona').value=p.note||'';
        $('salvaPersona').dataset.edit=p.id;
      };
      tb.append(tr);
    });
  }
  $('filtroPersona').oninput=renderPersone;
  $('salvaPersona').onclick=async ()=>{
    const n=$('nomePersona').value.trim(),
          c=$('cognomePersona').value.trim();
    if(!n||!c) return alert('Nome e cognome richiesti');
    const edit=$('salvaPersona').dataset.edit;
    const m=$('mansionePersona').value.trim(),
          nt=$('notePersona').value.trim();
    if(edit){
      await db.collection('persone').doc(edit).update({n,c,m,note:nt});
      delete $('salvaPersona').dataset.edit;
    } else {
      await db.collection('persone').add({n,c,m,note:nt});
    }
    ['nomePersona','cognomePersona','mansionePersona','notePersona'].forEach(id=>$ (id).value='');
    load();
  };

  // --- Pianificazione ---
  function populateCantieri(){
    const sel=$('selCantiere'); sel.innerHTML='<option value="">--- Seleziona ---</option>';
    cantieri.forEach(c=>sel.append(new Option(c.nome,c.nome)));
  }
  function aggiornaPersone(){
    const sel=$('selPersona'); sel.innerHTML=''; sel.disabled=!$('dataPlan').value;
    if(!$('dataPlan').value) return;
    const used=new Set(piani.filter(iv=>iv.data=== $('dataPlan').value).map(iv=>iv.idPersona));
    persone.filter(p=>!used.has(p.id))
           .forEach(p=>sel.append(new Option(p.n+' '+p.c,p.id)));
  }
  $('dataPlan').onchange=()=>{
    $('infoData').textContent = $('dataPlan').value? fmtFull(new Date($('dataPlan').value+'T00:00:00')) : '';
    aggiornaPersone();
    renderPianificazione();
  };
  $('assegna').onclick=async ()=>{
    const d=$('dataPlan').value, c=$('selCantiere').value;
    if(!d||!c) return alert('Data e cantiere!');
    const sel=Array.from($('selPersona').selectedOptions).map(o=>o.value);
    const nt=$('notePlan').value.trim();
    if(editingPlan){
      if(sel.length!==1) return alert('Modifica richiede 1');
      await db.collection('piani').doc(editingPlan)
        .update({data:d,c:c,idPersona:sel[0],note:nt});
      delete editingPlan;
    } else {
      for(const id of sel){
        if(!piani.find(iv=>iv.data===d&&iv.c===c&&iv.idPersona===id)){
          await db.collection('piani').add({data:d,c:c,idPersona:id,note:nt});
        }
      }
    }
    $('notePlan').value=''; aggiornaPersone(); load();
  };

  function renderPianificazione(){
    const hdr=$('planHeader'), bd=$('planBody');
    hdr.querySelectorAll('th:not(:first-child)').forEach(x=>x.remove());
    bd.innerHTML='';
    if(!$('dataPlan').value) return;
    const base=new Date($('dataPlan').value+'T00:00:00'),
          sett=weekDates(base),
          keys=sett.map(d=>iso(d)),
          cols=Array.from(new Set(piani
            .filter(iv=>keys.includes(iv.data))
            .map(iv=>iv.c))).sort();
    cols.forEach(c=>hdr.append(new Element('th',{},c)));
    sett.forEach(d=>{
      const tr=document.createElement('tr');
      const td0=document.createElement('td');
      td0.textContent=fmtFull(d);
      tr.append(td0);
      cols.forEach(c=>{
        const td=document.createElement('td');
        const ivs=piani.filter(iv=>iv.data===iso(d)&&iv.c===c);
        if(!ivs.length) td.textContent='-';
        else ivs.forEach(iv=>{
          const pers=persone.find(p=>p.id===iv.idPersona),
                nome=pers? pers.n+' '+pers.c:'(sconosciuto)';
          const div=document.createElement('div'); div.className='interv-cell';
          const span=document.createElement('span'); span.className='interv-name';
          span.textContent=nome+(iv.note? ' – '+iv.note:'');
          const act=document.createElement('div'); act.className='actions';
          const eb=document.createElement('button'); eb.textContent='Modifica'; eb.className='btn-edit';
          eb.onclick=()=>{
            editingPlan=iv.id;
            $('dataPlan').value=iv.data; $('dataPlan').dispatchEvent(new Event('change'));
            $('selCantiere').value=iv.c;
            aggiornaPersone();
            $('notePlan').value=iv.note||'';
            // seleziona quel dipendente
            $('selPersona').querySelectorAll('option').forEach(o=>o.selected=false);
            $('selPersona').querySelector(`option[value="${iv.idPersona}"]`).selected=true;
          };
          const dbtn=document.createElement('button'); dbtn.textContent='Cancella'; dbtn.className='btn-delete';
          dbtn.onclick=async()=>{
            if(!confirm('Cancelli intervento?')) return;
            await db.collection('piani').doc(iv.id).delete();
            load(); aggiornaPersone();
          };
          act.append(eb, dbtn);
          div.append(span, act);
          td.append(div);
        });
        tr.append(td);
      });
      bd.append(tr);
    });
  }

  // Avvio
  load();
})();
</script>
</body>
</html>
