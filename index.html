<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap:5px; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#f1c40f; }
  .btn-edit:hover { background:#d4ac0d; }
  .btn-delete { background:#e74c3c; }
  .btn-delete:hover { background:#c0392b; }
  td.date-cell { cursor:pointer; color:#2980b9; text-decoration: underline; }
  .week-display { font-style: italic; margin-top: 6px; }
  @media (max-width: 700px) { .tabs { flex-wrap: wrap; } }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" />
    <button id="btnSaveCant">Salva</button>
    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>
    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>
    <div id="dataPlanConGiorno" style="margin-top:6px; font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere">
      <option value="" disabled selected>-- Seleziona cantiere --</option>
    </select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <button id="btnAddPlan">Assegna</button>
    <button id="btnCancelEditPlan" style="display:none; margin-left:10px;">Annulla Modifica</button>

    <table id="tablePlan">
      <thead>
        <tr>
          <th>Data</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="btnExportSettimana" style="margin-top: 10px;">Esporta pianificazione settimanale</button>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>
    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />
    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />
    <table id="tableAnnual">
      <thead>
        <tr><th>Data</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="btnExportAnnual" style="margin-top:10px;">Esporta settimana</button>
  </div>
</div>
<script>
(() => {
  const firebaseConfig = {...};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let cantieri = [], persone = [], piani = [];
  let editingPlanId = null;

  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.addEventListener('click', ()=>{/*...*/}));

  async function caricaDati() {
    /* carica cantieri, persone, piani, poi render */
  }

  document.getElementById('btnAddPlan').onclick = async () => {
    /* salva o aggiorna pianificazione */
    await caricaDati(); initPlan();
  };
  document.getElementById('btnCancelEditPlan').onclick = () => {/* annulla modifica */};

  async function cancellaPianificazione(id) {
    await db.collection('piani').doc(id).delete();
    await caricaDati(); initPlan();
  }

  function renderPlan() {
    /* genera header */
    const tbody = document.querySelector('#tablePlan tbody'); tbody.innerHTML='';
    /* raggruppa e crea righe */
    piani.sort((a,b)=>a.d.localeCompare(b.d)).forEach(plan => {
      const tr = document.createElement('tr');
      /* ogni cella di cantiere */
      const btnEd = document.createElement('button'); btnEd.textContent='✏️'; btnEd.onclick = () => editPlan(plan);
      const btnDel = document.createElement('button'); btnDel.textContent='✖️'; btnDel.onclick = () => { if(confirm('Confermi cancellazione?')) cancellaPianificazione(plan.id); };
      /* aggiungi bottoni nel td */
    });
  }

  function editPlan(plan) {
    editingPlanId = plan.id;
    document.getElementById('dataPlan').value = plan.d;
    document.getElementById('selectCantiere').value = plan.c;
    document.getElementById('notePlan').value = plan.n;
    /* aggiorna lista dipendenti e seleziona quelli di plan.p */
    document.getElementById('btnAddPlan').textContent='Aggiorna';
    document.getElementById('btnCancelEditPlan').style.display = 'inline-block';
  }

  /* initPlan, populateCantieriSelect, updatePlanLists, renderAnnual, date util */
  window.cancellaPianificazione = cancellaPianificazione;
  caricaDati();
})();
</script>
</body>
</html>
