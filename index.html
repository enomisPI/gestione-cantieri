<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Cantieri e Personale - con Firebase</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    h1, h2 { color: #2c3e50; }
    .container { max-width: 1100px; margin: auto; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background: #34495e; color: #fff; padding: 10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; }
    .tab.active { background: #2c3e50; font-weight: bold; }
    .content { display: none; background: #fff; padding: 20px; border-radius: 0 4px 4px 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .content.active { display: block; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea, button { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
    select[multiple] { height: 130px; }
    button { background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    th { background: #34495e; color: #fff; }
    .btn-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
    .btn-edit { background: #f1c40f; }
    .btn-edit:hover { background: #d4ac0d; }
    .btn-delete { background: #e74c3c; }
    .btn-delete:hover { background: #c0392b; }
    .small-btn { width: auto; margin: 2px 0; font-size: 0.9em; padding: 4px 8px; }
    .week-display { font-style: italic; margin-top: 6px; }
    @media (max-width: 700px) { .tabs { flex-wrap: wrap; } }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" />
    <button id="btnSaveCant">Salva</button>
    <table>
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody id="tbodyCantieri"></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>
    <table>
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody id="tbodyPers"></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>
    <div id="dataPlanConGiorno"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere"><option value="" disabled selected>-- Seleziona cantiere --</option></select>

    <label for="selectPers">Dipendenti</label>
    <select id="selectPers" multiple></select>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <button id="btnAddPlan">Assegna</button>
    <button id="btnCancelEditPlan" style="display:none; margin-top:10px;">Annulla Modifica</button>

    <table>
      <thead><tr><th>Data</th><th>Cantiere</th><th>Dipendenti</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody id="tbodyPlan"></tbody>
    </table>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale</h2>
    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />
    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />
    <table>
      <thead><tr><th>Data</th><th>Dettagli</th></tr></thead>
      <tbody id="tbodyAnnual"></tbody>
    </table>
  </div>
</div>
<script>
(() => {
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let cantieri = [], persone = [], piani = [];
  let editingCant = null, editingPers = null, editingPlan = null;

  // Utils date
  function getWeek(d) {
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  }
  function formatDate(d) { return ('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear(); }
  function nomeGiorno(d) { const g=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato']; return g[d.getDay()]; }

  // Tabs switch
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab, .content').forEach(el => el.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if(tab.dataset.tab==='pianificazione') setupPlan();
      if(tab.dataset.tab==='annuale') renderAnnual();
    });
  });

  // Load initial data
  async function caricaDati() {
    const cSnap = await db.collection('cantieri').get(); cantieri = cSnap.docs.map(d=>({id:d.id,nome:d.data().nome})); renderCantieri();
    const pSnap = await db.collection('persone').get(); persone = pSnap.docs.map(d=>({id:d.id,...d.data()})); renderPersone();
    const planSnap = await db.collection('piani').get(); piani = planSnap.docs.map(d=>({id:d.id,...d.data()})); renderPlanList();
  }

  // Cantieri CRUD
  document.getElementById('btnSaveCant').addEventListener('click', async()=>{
    const v=document.getElementById('nomeCantiere').value.trim(); if(!v)return alert('Inserisci nome');
    if(editingCant){ await db.collection('cantieri').doc(editingCant).update({nome:v}); editingCant=null; document.getElementById('btnSaveCant').textContent='Salva'; }
    else await db.collection('cantieri').add({nome:v});
    document.getElementById('nomeCantiere').value=''; caricaDati();
  });
  function renderCantieri(){ const tb=document.getElementById('tbodyCantieri'); tb.innerHTML=''; cantieri.forEach(c=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td><div class='btn-wrapper'></div></td>`;
    const w=tr.querySelector('.btn-wrapper');
    const e=document.createElement('button');e.textContent='Modifica';e.className='btn-edit small-btn';e.onclick=()=>{
      editingCant=c.id;document.getElementById('nomeCantiere').value=c.nome;document.getElementById('btnSaveCant').textContent='Aggiorna';};
    const d=document.createElement('button');d.textContent='Cancella';d.className='btn-delete small-btn';d.onclick=async()=>{if(confirm('Confermi?')){await db.collection('cantieri').doc(c.id).delete();caricaDati();}};
    w.append(e,d);tb.append(tr);
  });}

  // Personale CRUD
  document.getElementById('btnSavePers').addEventListener('click', async()=>{
    const n=document.getElementById('nomePersona').value.trim(),cogn=document.getElementById('cognomePersona').value.trim();
    if(!n||!cogn)return alert('Nome e cognome obbligatori');
    const data={n,c:cogn,m:document.getElementById('mansionePersona').value.trim(),note:document.getElementById('notePersona').value.trim()};
    if(editingPers){ await db.collection('persone').doc(editingPers).update(data); editingPers=null; document.getElementById('btnSavePers').textContent='Salva'; }
    else await db.collection('persone').add(data);
    ['nomePersona','cognomePersona','mansionePersona','notePersona'].forEach(id=>document.getElementById(id).value=''); caricaDati();
  });
  function renderPersone(){ const tb=document.getElementById('tbodyPers'); tb.innerHTML=''; persone.forEach(p=>{
    const tr=document.createElement('tr');tr.innerHTML=`<td>${p.n}</td><td>${p.c}</td><td>${p.m||''}</td><td>${p.note||''}</td><td><div class='btn-wrapper'></div></td>`;
    const w=tr.querySelector('.btn-wrapper');
    const e=document.createElement('button');e.textContent='Modifica';e.className='btn-edit small-btn';e.onclick=()=>{
      editingPers=p.id;document.getElementById('nomePersona').value=p.n;document.getElementById('cognomePersona').value=p.c;
      document.getElementById('mansionePersona').value=p.m;document.getElementById('notePersona').value=p.note;document.getElementById('btnSavePers').textContent='Aggiorna';};
    const d=document.createElement('button');d.textContent='Cancella';d.className='btn-delete small-btn';d.onclick=async()=>{if(confirm('Confermi?')){await db.collection('persone').doc(p.id).delete();caricaDati();}};
    w.append(e,d);tb.append(tr);
  });}

  // Pianificazione
  document.getElementById('btnAddPlan').addEventListener('click', async()=>{
    const d=document.getElementById('dataPlan').value,c=document.getElementById('selectCantiere').value;
    const p=Array.from(document.getElementById('selectPers').selectedOptions).map(o=>o.value);
    const n=document.getElementById('notePlan').value.trim(); if(!d||!c||p.length===0)return alert('Completa i campi');
    if(editingPlan){ await db.collection('piani').doc(editingPlan).update({d,c,p,n}); editingPlan=null; document.getElementById('btnAddPlan').textContent='Assegna'; document.getElementById('btnCancelEditPlan').style.display='none'; }
    else await db.collection('piani').add({d,c,p,n});
    setupPlan(); caricaDati();
  });
  document.getElementById('btnCancelEditPlan').addEventListener('click', ()=>{ editingPlan=null; document.getElementById('btnAddPlan').textContent='Assegna'; document.getElementById('btnCancelEditPlan').style.display='none'; setupPlan(); });

  function setupPlan(){
    // rebuild selects
    const sc=document.getElementById('selectCantiere'); sc.innerHTML='<option value="" disabled selected>-- Seleziona cantiere --</option>'+cantieri.map(c=>`<option value="${c.nome}">${c.nome}</option>`).join('');
    const dval=document.getElementById('dataPlan').value; const used=new Set(piani.filter(p=>p.d===dval).flatMap(p=>p.p));
    const sp=document.getElementById('selectPers'); sp.innerHTML=persone.filter(p=>!used.has(p.id)).map(p=>`<option value="${p.id}">${p.n} ${p.c}</option>`).join('');
    renderPlanList();
  }
  function renderPlanList(){ const tb=document.getElementById('tbodyPlan'); tb.innerHTML='';
    piani.sort((a,b)=>a.d.localeCompare(b.d)).forEach(plan=>{
      const dip=plan.p.map(id=>{const x=persone.find(pp=>pp.id===id);return x?x.n+' '+x.c:'?';}).join(', ');
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${plan.d}</td><td>${plan.c}</td><td>${dip}</td><td>${plan.n}</td><td><div class='btn-wrapper'></div></td>`;
      const w=tr.querySelector('.btn-wrapper');
      const e=document.createElement('button');e.textContent='✏️';e.className='btn-edit small-btn';e.onclick=()=>{
        editingPlan=plan.id;document.getElementById('dataPlan').value=plan.d;document.getElementById('notePlan').value=plan.n;
        document.getElementById('btnAddPlan').textContent='Aggiorna';document.getElementById('btnCancelEditPlan').style.display='block';setupPlan();
        Array.from(document.getElementById('selectPers').options).forEach(o=>o.selected=plan.p.includes(o.value));
      };
      const d=document.createElement('button');d.textContent='✖️';d.className='btn-delete small-btn';d.onclick=async()=>{if(confirm('Confermi?')){await db.collection('piani').doc(plan.id).delete();caricaDati();}};
      w.append(e,d);tb.append(tr);
    });
  }

  // Annuale
  function renderAnnual(){
    const w=parseInt(document.getElementById('numWeekSelect').value), y=parseInt(document.getElementById('yearSelect').value);
    const start=new Date(y,0,1+(w-1)*7); const dow=start.getDay(); if(dow<=4) start.setDate(start.getDate()-start.getDay()+1); else start.setDate(start.getDate()+8-start.getDay());
    const tb=document.getElementById('tbodyAnnual'); tb.innerHTML='';
    for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i);
      const iso=d.toISOString().slice(0,10), dip=piani.filter(p=>p.d===iso).map(p=>p.c+': '+p.p.map(id=>{const pp=persone.find(x=>x.id===id);return pp?pp.n+' '+pp.c:'?';}).join(', ')).join('<br>');
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${formatDate(d)}</td><td>${dip}</td>`; tb.append(tr);
    }
  }
  document.getElementById('numWeekSelect').addEventListener('change', renderAnnual);
  document.getElementById('yearSelect').addEventListener('change', renderAnnual);

  // init
  caricaDati();
})();
</script>
</body>
</html>