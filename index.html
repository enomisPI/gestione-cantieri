<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Cantieri e Personale - con Firebase (v2)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:20px; }
    h1,h2 { color:#2c3e50; }
    .version { font-size:0.9em; color:#7f8c8d; margin-bottom:10px; }
    .container { max-width: 1100px; margin: auto; }
    .tabs { display: flex; gap:10px; margin-bottom: 20px; }
    .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
    .tab.active { background:#2c3e50; font-weight:bold; }
    .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
    .content.active { display:block; }
    .search-bar { margin-bottom:15px; }
    .search-bar input { padding:6px; width:200px; box-sizing:border-box; color:#7f8c8d; }
    .search-bar button { padding:6px 14px; border:none; background:#16a085; color:#fff; border-radius:4px; cursor:pointer; margin-left:5px; }
    .search-bar button:hover { background:#138f75; }
    label { font-weight:bold; margin-top:10px; display:block; }
    input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; color:#2c3e50; }
    input::placeholder, textarea::placeholder { color: #7f8c8d; }
    textarea { resize: vertical; }
    select[multiple] { height: 130px; }
    button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
    button:hover { background:#2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
    th { background:#34495e; color:#fff; }
    .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
    .btn-edit { background:#27ae60; margin-right:5px; }
    .btn-edit:hover { background:#1e8449; }
    .btn-delete { background:#e74c3c; }
    .btn-delete:hover { background:#c0392b; }
    .week-display { font-style: italic; margin-top: 6px; }
    @media (max-width: 700px) {
      .tabs { flex-wrap: wrap; }
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="version">Versione 2</div>

  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <div class="search-bar">
      <input type="text" id="searchCant" placeholder="Cerca cantiere..." />
      <button id="btnSearchCant">Cerca</button>
    </div>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" />
    <button id="btnSaveCant">Salva</button>

    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <div class="search-bar">
      <input type="text" id="searchPers" placeholder="Cerca per nome, cognome o mansione..." />
      <button id="btnSearchPers">Cerca</button>
    </div>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>

    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <div class="search-bar">
      <input type="text" id="searchPlan" placeholder="Cerca per data o cantiere..." />
      <button id="btnSearchPlan">Cerca</button>
    </div>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere">
      <option value="">-- Seleziona cantiere --</option>
    </select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2" placeholder="Note intervento (opzionale)"></textarea>

    <button id="btnAddPlan">Assegna</button>

    <table id="tablePlan">
      <thead><tr><th>Data</th><!-- dinamico --></tr></thead>
      <tbody></tbody>
    </table>

    <button id="btnExportSettimana" style="margin-top: 10px;">Esporta pianificazione settimanale</button>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>
    <div class="search-bar">
      <input type="text" id="searchAnnual" placeholder="Cerca settimana o anno..." />
      <button id="btnSearchAnnual">Cerca</button>
    </div>

    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />
    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />

    <table id="tableAnnual">
      <thead><tr><th>Data</th><!-- dinamico --></tr></thead>
      <tbody></tbody>
    </table>

    <button id="btnExportAnnual" style="margin-top:10px;">Esporta settimana</button>
  </div>
</div>

<script>
(() => {
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cantieri = [], persone = [], piani = [];

  // GESTIONE TABS
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if (tab.dataset.tab === 'pianificazione') initPlan();
      if (tab.dataset.tab === 'annuale') renderAnnual();
    });
  });

  // CARICA DATI
  async function caricaDati() {
    const cSnap = await db.collection('cantieri').get();
    cantieri = cSnap.docs.map(d => d.data().nome);
    renderCant(cantieri);
    populateCantieriSelect();

    const pSnap = await db.collection('persone').get();
    persone = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderPers(persone);

    const planSnap = await db.collection('piani').get();
    piani = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderPlan();
    renderAnnual();
  }

  // SALVA / CANCELLA FUNZIONI
  async function salvaCantiere(nome) {
    if (cantieri.includes(nome)) throw new Error("Cantiere già presente");
    await db.collection('cantieri').add({ nome });
    await caricaDati();
  }
  async function cancellaCantiere(nome) {
    const docs = await db.collection('cantieri').where('nome','==',nome).get();
    docs.forEach(d=>d.ref.delete());
    const pd = await db.collection('piani').where('c','==',nome).get();
    pd.forEach(d=>d.ref.delete());
    await caricaDati();
  }
  async function salvaPersona(p) {
    if (persone.find(x=>x.n===p.n && x.c===p.c)) throw new Error("Persona già presente");
    await db.collection('persone').add(p);
    await caricaDati();
  }
  async function cancellaPersona(id) {
    await db.collection('persone').doc(id).delete();
    const all = await db.collection('piani').get();
    all.docs.forEach(d=>{
      if (d.data().p.includes(id)) d.ref.delete();
    });
    await caricaDati();
  }
  async function salvaPianificazione(plan) {
    await db.collection('piani').add(plan);
    await caricaDati();
  }

  // --- CANTIERI RENDER + SEARCH + SAVE ---
  document.getElementById('btnSaveCant').onclick = async () => {
    const v = document.getElementById('nomeCantiere').value.trim();
    if (!v) return alert('Inserisci nome cantiere');
    try { await salvaCantiere(v); document.getElementById('nomeCantiere').value = ''; }
    catch(e){ alert(e.message); }
  };
  function renderCant(list) {
    const tb = document.querySelector('#tableCantieri tbody');
    tb.innerHTML = '';
    list.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c}</td>
        <td>
          <button class="btn-edit" data-nome="${c}">Modifica</button>
          <button class="btn-delete" data-nome="${c}">Cancella</button>
        </td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('.btn-delete').forEach(b=>b.onclick=()=>{
      if(confirm('Confermi cancellazione?')) cancellaCantiere(b.dataset.nome);
    });
    // Modifica lato client non implementata ora
  }
  document.getElementById('btnSearchCant').onclick = () => {
    const q = document.getElementById('searchCant').value.toLowerCase();
    renderCant(cantieri.filter(c => c.toLowerCase().includes(q)));
  };

  // --- PERSONALE RENDER + SEARCH + SAVE ---
  document.getElementById('btnSavePers').onclick = async () => {
    const n = document.getElementById('nomePersona').value.trim();
    const c = document.getElementById('cognomePersona').value.trim();
    const m = document.getElementById('mansionePersona').value.trim();
    const note = document.getElementById('notePersona').value.trim();
    if (!n||!c) return alert('Nome e cognome obbligatori');
    try {
      await salvaPersona({ n, c, m, note });
      ['nomePersona','cognomePersona','mansionePersona','notePersona'].forEach(id=>document.getElementById(id).value='');
    } catch(e){ alert(e.message); }
  };
  function renderPers(list) {
    const tb = document.querySelector('#tablePersonale tbody');
    tb.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.n}</td><td>${p.c}</td><td>${p.m||''}</td><td>${p.note||''}</td>
        <td>
          <button class="btn-edit" data-id="${p.id}">Modifica</button>
          <button class="btn-delete" data-id="${p.id}">Cancella</button>
        </td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('.btn-delete').forEach(b=>b.onclick=()=>{
      if(confirm('Confermi cancellazione?')) cancellaPersona(b.dataset.id);
    });
  }
  document.getElementById('btnSearchPers').onclick = () => {
    const q = document.getElementById('searchPers').value.toLowerCase();
    renderPers(persone.filter(p=>
      p.n.toLowerCase().includes(q) ||
      p.c.toLowerCase().includes(q) ||
      (p.m||'').toLowerCase().includes(q)
    ));
  };

  // --- PIANIFICAZIONE ---
  const dataPlan = document.getElementById('dataPlan');
  const weekDisplay = document.getElementById('weekDisplay');
  const selectCantiere = document.getElementById('selectCantiere');
  const selectPers = document.getElementById('selectPers');
  const notePlan = document.getElementById('notePlan');

  function populateCantieriSelect() {
    selectCantiere.innerHTML = '<option value="">-- Seleziona cantiere --</option>';
    cantieri.forEach(c => {
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      selectCantiere.appendChild(o);
    });
  }
  function updatePlanLists() {
    const used = new Set(piani.map(p => p.c));
    selectPers.innerHTML = '';
    persone.forEach(p => {
      if (!used.has(p.id)) {
        const o = document.createElement('option');
        o.value = p.id; o.textContent = `${p.n} ${p.c}`;
        selectPers.appendChild(o);
      }
    });
  }
  dataPlan.onchange = () => {
    const d = dataPlan.value;
    if (!d) { weekDisplay.textContent = ''; return; }
    const dt = new Date(d);
    const wk = Math.ceil((((dt - new Date(dt.getFullYear(),0,1)) / 86400000)+dt.getDay()+1)/7);
    weekDisplay.textContent = 'Settimana: ' + wk;
    updatePlanLists();
  };
  document.getElementById('btnAddPlan').onclick = async () => {
    if (!dataPlan.value) return alert('Seleziona data');
    if (!selectCantiere.value) return alert('Seleziona cantiere');
    const arr = [...selectPers.selectedOptions].map(o=>o.value);
    if (!arr.length) return alert('Seleziona almeno un dipendente');
    await salvaPianificazione({ d: dataPlan.value, c: selectCantiere.value, p: arr, n: notePlan.value.trim() });
    selectCantiere.value=''; notePlan.value=''; dataPlan.value=''; weekDisplay.textContent=''; renderPlan();
  };

  function renderPlan() {
    const usedCant = Array.from(new Set(piani.map(p=>p.c)));
    const head = document.querySelector('#tablePlan thead tr');
    head.innerHTML = '<th>Data</th>';
    usedCant.forEach(c=> head.innerHTML += `<th>${c}</th>`);
    const body = document.querySelector('#tablePlan tbody');
    body.innerHTML = '';
    const group = {};
    piani.forEach(p=> { group[p.d]=group[p.d]||[]; group[p.d].push(p); });
    Object.keys(group).sort().forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d}</td>`;
      usedCant.forEach(c=>{
        const items = (group[d].filter(x=>x.c===c) || []);
        if (!items.length) tr.innerHTML += '<td></td>';
        else {
          let txt='';
          items.forEach(x=>{
            const names = x.p.map(id=>{
              const pp = persone.find(z=>z.id===id);
              return pp?`${pp.n} ${pp.c}`:'?';
            }).join(', ');
            txt += names + (x.n?` (${x.n})`:'') + '<br>';
          });
          tr.innerHTML += `<td>${txt}</td>`;
        }
      });
      body.appendChild(tr);
    });
  }
  document.getElementById('btnSearchPlan').onclick = () => {
    // implementa se serve
  };

  // --- ANNUALE ---
  const numWeek = document.getElementById('numWeekSelect');
  const yearSel = document.getElementById('yearSelect');
  function getISOStart(w,y){
    const d = new Date(y,0,4);
    const day = d.getDay()||7;
    d.setDate(d.getDate() + (w-1)*7 - (day-1));
    return d;
  }
  function renderAnnual(){
    const w = parseInt(numWeek.value), y = parseInt(yearSel.value);
    if (!w||!y) return;
    const head = document.querySelector('#tableAnnual thead tr');
    head.innerHTML = '<th>Data</th>';
    cantieri.forEach(c=> head.innerHTML += `<th>${c}</th>`);
    const body = document.querySelector('#tableAnnual tbody');
    body.innerHTML = '';
    const start = getISOStart(w,y);
    for(let i=0;i<7;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const iso = d.toISOString().slice(0,10);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${('0'+d.getDate()).slice(-2)}/${('0'+(d.getMonth()+1)).slice(-2)}/${d.getFullYear()}</td>`;
      cantieri.forEach(c=>{
        const items = piani.filter(p=>p.d===iso&&p.c===c);
        if(!items.length) tr.innerHTML+='<td></td>';
        else{
          let txt='';
          items.forEach(x=>{
            const names = x.p.map(id=>{
              const pp=persone.find(z=>z.id===id);
              return pp?`${pp.n} ${pp.c}`:'?';
            }).join(', ');
            txt+=names+(x.n?` (${x.n})`:'')+'<br>';
          });
          tr.innerHTML+=`<td>${txt}</td>`;
        }
      });
      body.appendChild(tr);
    }
  }
  numWeek.onchange = renderAnnual;
  yearSel.onchange = renderAnnual;
  document.getElementById('btnSearchAnnual').onclick = () => {
    // implementa se serve
  };

  // INIT
  function initPlan(){ dataPlan.value=''; weekDisplay.textContent=''; populateCantieriSelect(); updatePlanLists(); }
  caricaDati();
})();
</script>

</body>
</html>
