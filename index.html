<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Cantieri e Personale - con Firebase</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; margin:20px; }
  h1,h2 { color:#2c3e50; }
  .container { max-width: 1100px; margin: auto; }
  .tabs { display: flex; gap:10px; margin-bottom: 20px; }
  .tab { background:#34495e; color:#fff; padding:10px 20px; border-radius: 4px 4px 0 0; cursor: pointer; user-select:none; }
  .tab.active { background:#2c3e50; font-weight:bold; }
  .content { background:#fff; padding:20px; border-radius: 0 4px 4px 4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; overflow-x:auto; }
  .content.active { display:block; }
  label { font-weight:bold; margin-top:10px; display:block; }
  input, select, textarea { width: 100%; padding:6px; margin-top:4px; box-sizing: border-box; }
  textarea { resize: vertical; }
  select[multiple] { height: 130px; }
  button { margin-top: 10px; padding: 6px 14px; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2980b9; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; word-wrap: break-word; }
  th { background:#34495e; color:#fff; }
  .btn-edit, .btn-delete { border:none; padding:5px 10px; border-radius:3px; color:#fff; cursor:pointer; }
  .btn-edit { background:#3498db; margin-right:5px; }
  .btn-edit:hover { background:#2980b9; }
  .btn-delete { background:#e74c3c; }
  .btn-delete:hover { background:#c0392b; }
  td.date-cell { cursor:pointer; color:#2980b9; text-decoration: underline; }
  .week-display { font-style: italic; margin-top: 6px; }
  @media (max-width: 700px) {
    .tabs { flex-wrap: wrap; }
  }
  /* Filtri di ricerca */
  #filterCantieri, #filterPersone {
    padding: 6px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestione Cantieri e Personale</h1>
  <div class="tabs">
    <div class="tab active" data-tab="cantieri">Cantieri</div>
    <div class="tab" data-tab="personale">Personale</div>
    <div class="tab" data-tab="pianificazione">Pianificazione</div>
    <div class="tab" data-tab="annuale">Anteprima Annuale</div>
  </div>

  <!-- Cantieri -->
  <div id="cantieri" class="content active">
    <h2>Cantieri</h2>
    <label for="nomeCantiere">Nome cantiere</label>
    <input id="nomeCantiere" placeholder="Inserisci nome cantiere" maxlength="50" />
    <button id="btnSaveCant">Salva</button>

    <label for="filterCantieri">Filtra cantieri</label>
    <input id="filterCantieri" placeholder="Cerca cantiere..." />

    <table id="tableCantieri">
      <thead><tr><th>Nome</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Personale -->
  <div id="personale" class="content">
    <h2>Personale</h2>
    <label for="nomePersona">Nome</label>
    <input id="nomePersona" placeholder="Nome" maxlength="30" />
    <label for="cognomePersona">Cognome</label>
    <input id="cognomePersona" placeholder="Cognome" maxlength="30" />
    <label for="mansionePersona">Mansione</label>
    <input id="mansionePersona" placeholder="Mansione" maxlength="50" />
    <label for="notePersona">Note</label>
    <textarea id="notePersona" rows="2" placeholder="Note su persona (opzionale)"></textarea>
    <button id="btnSavePers">Salva</button>

    <label for="filterPersone">Filtra persone</label>
    <input id="filterPersone" placeholder="Cerca persona..." />

    <table id="tablePersonale">
      <thead><tr><th>Nome</th><th>Cognome</th><th>Mansione</th><th>Note</th><th>Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pianificazione -->
  <div id="pianificazione" class="content">
    <h2>Pianificazione</h2>
    <label for="dataPlan">Data intervento</label>
    <input type="date" id="dataPlan" />
    <div class="week-display" id="weekDisplay"></div>
    <div id="dataPlanConGiorno" style="margin-top:6px; font-weight:bold;"></div>

    <label for="selectCantiere">Cantiere</label>
    <select id="selectCantiere"></select>

    <label for="selectPers">Dipendenti (seleziona uno o più)</label>
    <select id="selectPers" multiple></select>

    <label for="notePlan">Note</label>
    <textarea id="notePlan" rows="2"></textarea>

    <button id="btnAddPlan">Assegna</button>

    <table id="tablePlan">
      <thead>
        <tr>
          <th>Data</th>
          <!-- Colonne dinamiche cantieri qui -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportSettimana" style="margin-top: 10px;">Esporta pianificazione settimanale</button>
  </div>

  <!-- Anteprima Annuale -->
  <div id="annuale" class="content">
    <h2>Anteprima Annuale - Seleziona Settimana e Anno</h2>

    <label for="numWeekSelect">Settimana #</label>
    <input type="number" id="numWeekSelect" min="1" max="54" value="1" />

    <label for="yearSelect">Anno</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025" />

    <table id="tableAnnual">
      <thead>
        <tr>
          <th>Data</th>
          <!-- colonne dinamiche cantieri -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportAnnual" style="margin-top:10px;">Esporta settimana</button>
  </div>
</div>

<script>
(() => {
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuuDAmZeR0TV7FZHt8uK4LQRrfCyGMtNA",
    authDomain: "gestione-cantieri-5c820.firebaseapp.com",
    projectId: "gestione-cantieri-5c820",
    storageBucket: "gestione-cantieri-5c820.appspot.com",
    messagingSenderId: "591449856782",
    appId: "1:591449856782:web:e7c218671fc488ea19d55f",
    measurementId: "G-7NFGJPEFWL"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Dati
  let cantieri = [];
  let persone = [];
  let piani = [];

  // Editing cantieri
  let editingCantId = null;

  // --- Elementi ---
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.content');

  const inputCant = document.getElementById('nomeCantiere');
  const btnSaveCant = document.getElementById('btnSaveCant');
  const tableCant = document.querySelector('#tableCantieri tbody');
  const filterCantieri = document.getElementById('filterCantieri');

  const inputNomePers = document.getElementById('nomePersona');
  const inputCogPers = document.getElementById('cognomePersona');
  const inputMansione = document.getElementById('mansionePersona');
  const inputNotePers = document.getElementById('notePersona');
  const btnSavePers = document.getElementById('btnSavePers');
  const tablePers = document.querySelector('#tablePersonale tbody');
  const filterPersone = document.getElementById('filterPersone');

  const dataPlan = document.getElementById('dataPlan');
  const weekDisplay = document.getElementById('weekDisplay');
  const dataPlanConGiorno = document.getElementById('dataPlanConGiorno');
  const selectCantiere = document.getElementById('selectCantiere');
  const selectPers = document.getElementById('selectPers');
  const notePlan = document.getElementById('notePlan');
  const btnAddPlan = document.getElementById('btnAddPlan');
  const tablePlan = document.getElementById('tablePlan');
  const tablePlanBody = tablePlan.querySelector('tbody');
  const tablePlanHead = tablePlan.querySelector('thead tr');

  // --- Funzioni Firestore con async/await in loop corretti ---
  async function caricaDati() {
    try {
      const cantiereSnap = await db.collection('cantieri').get();
      cantieri = cantiereSnap.docs.map(doc => ({id: doc.id, nome: doc.data().nome}));
      renderCant();
      populateCantieriSelect();

      const personeSnap = await db.collection('persone').get();
      persone = personeSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPers();
      updatePlanLists();

      const pianiSnap = await db.collection('piani').get();
      piani = pianiSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
      renderPlan();
      renderAnnual();
    } catch (e) {
      console.error('Errore caricamento dati:', e);
      alert('Errore caricamento dati: ' + e.message);
    }
  }

  async function salvaCantiere(nome) {
    if(cantieri.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
      throw new Error("Cantiere già presente");
    }
    await db.collection('cantieri').add({nome});
    await caricaDati();
  }

  async function aggiornaCantiere(id, nome) {
    if(cantieri.find(c => c.nome.toLowerCase() === nome.toLowerCase() && c.id !== id)) {
      throw new Error("Cantiere già presente con questo nome");
    }
    await db.collection('cantieri').doc(id).update({nome});
    await caricaDati();
  }

  async function cancellaCantiere(id) {
    try {
      // Prima prendi nome per cancellare piani associati
      const cantiere = cantieri.find(c => c.id === id);
      if(!cantiere) throw new Error("Cantiere non trovato");
      await db.collection('cantieri').doc(id).delete();

      // Cancella piani associati
      const pianiDocs = await db.collection('piani').where('c', '==', cantiere.nome).get();
      for(const doc of pianiDocs.docs) {
        await doc.ref.delete();
      }

      await caricaDati();
    } catch(e) {
      console.error('Errore cancellazione cantiere:', e);
      alert('Errore cancellazione cantiere: ' + e.message);
    }
  }

  async function salvaPersona(persona) {
    if(persone.find(p => p.n.toLowerCase() === persona.n.toLowerCase() && p.c.toLowerCase() === persona.c.toLowerCase())) {
      throw new Error("Persona già presente");
    }
    await db.collection('persone').add(persona);
    await caricaDati();
  }

  async function cancellaPersona(id) {
    try {
      await db.collection('persone').doc(id).delete();

      // Rimuovi piani con questa persona
      const pianiDocs = await db.collection('piani').get();
      for(const doc of pianiDocs.docs) {
        const data = doc.data();
        if(data.p.includes(id)) {
          await doc.ref.delete();
        }
      }
      await caricaDati();
    } catch(e) {
      console.error('Errore cancellazione persona:', e);
      alert('Errore cancellazione persona: ' + e.message);
    }
  }

  async function salvaPianificazione(plan) {
    await db.collection('piani').add(plan);
    await caricaDati();
  }

  async function cancellaPianificazione(id) {
    await db.collection('piani').doc(id).delete();
    await caricaDati();
  }

  // --- Gestione Cantieri ---
  btnSaveCant.onclick = async () => {
    const val = inputCant.value.trim();
    if(!val) return alert('Inserisci nome cantiere');
    if(val.length > 50) return alert('Nome cantiere troppo lungo (max 50 caratteri)');
    try {
      if(editingCantId) {
        await aggiornaCantiere(editingCantId, val);
        editingCantId = null;
        btnSaveCant.textContent = 'Salva';
      } else {
        await salvaCantiere(val);
      }
      inputCant.value = '';
      renderCant();
    } catch(e) {
      alert(e.message);
    }
  };

  function renderCant() {
    const filtro = filterCantieri.value.toLowerCase();
    tableCant.innerHTML = '';
    cantieri.filter(c => c.nome.toLowerCase().includes(filtro)).forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.nome}</td>
        <td>
          <button class="btn-edit" data-id="${c.id}" data-nome="${c.nome}">Modifica</button>
          <button class="btn-delete" data-id="${c.id}">Cancella</button>
        </td>`;
      tableCant.appendChild(tr);
    });

    tableCant.querySelectorAll('button.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questo cantiere?')) {
          await cancellaCantiere(btn.dataset.id);
        }
      };
    });

    tableCant.querySelectorAll('button.btn-edit').forEach(btn => {
      btn.onclick = () => {
        editingCantId = btn.dataset.id;
        inputCant.value = btn.dataset.nome;
        btnSaveCant.textContent = 'Aggiorna';
        // Vai alla tab cantieri e focus input
        tabs.forEach(t => {
          t.classList.toggle('active', t.dataset.tab === 'cantieri');
        });
        contents.forEach(c => {
          c.classList.toggle('active', c.id === 'cantieri');
        });
        inputCant.focus();
      };
    });
  }

  filterCantieri.addEventListener('input', renderCant);

  // --- Gestione Personale ---
  btnSavePers.onclick = async () => {
    const n = inputNomePers.value.trim();
    const c = inputCogPers.value.trim();
    const m = inputMansione.value.trim();
    const note = inputNotePers.value.trim();
    if(!n || !c) return alert('Inserisci nome e cognome');
    if(n.length > 30 || c.length > 30) return alert('Nome o cognome troppo lungo (max 30 caratteri)');
    if(m.length > 50) return alert('Mansione troppo lunga (max 50 caratteri)');
    try {
      await salvaPersona({n,c,m,note});
      inputNomePers.value = '';
      inputCogPers.value = '';
      inputMansione.value = '';
      inputNotePers.value = '';
      renderPers();
    } catch(e) {
      alert(e.message);
    }
  };

  function renderPers() {
    const filtro = filterPersone.value.toLowerCase();
    tablePers.innerHTML = '';
    persone.filter(p => (p.n + ' ' + p.c).toLowerCase().includes(filtro)).forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.n}</td><td>${p.c}</td><td>${p.m || ''}</td><td>${p.note || ''}</td>
        <td>
          <button class="btn-delete" data-id="${p.id}">Cancella</button>
        </td>`;
      tablePers.appendChild(tr);
    });

    tablePers.querySelectorAll('button.btn-delete').forEach(btn => {
      btn.onclick = async () => {
        if(confirm('Sei sicuro di cancellare questa persona?')) {
          await cancellaPersona(btn.dataset.id);
        }
      };
    });
  }

  filterPersone.addEventListener('input', renderPers);

  // --- Gestione Pianificazione ---
  function populateCantieriSelect() {
    selectCantiere.innerHTML = '';
    cantieri.forEach(c => {
      const option = document.createElement('option');
      option.value = c.nome;
      option.textContent = c.nome;
      selectCantiere.appendChild(option);
    });
  }

  function updatePlanLists() {
    const usati = new Set();
    const d = dataPlan.value;
    piani.forEach(p => {
      if(p.d === d) {
        p.p.forEach(id => usati.add(id));
      }
    });
    selectPers.innerHTML = '';
    persone.forEach(p => {
      if(!usati.has(p.id)) {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.n + ' ' + p.c;
        selectPers.appendChild(option);
      }
    });
  }

  // Funzioni per settimana e giorno
  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }
  function getDayName(d) {
    return ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'][d.getDay()];
  }

  // Aggiorna info data e settimana
  dataPlan.addEventListener('change', () => {
    if(!dataPlan.value) {
      weekDisplay.textContent = '';
      dataPlanConGiorno.textContent = '';
      return;
    }
    const d = new Date(dataPlan.value);
    const weekNum = getWeekNumber(d);
    weekDisplay.textContent = `Settimana #${weekNum} - ${d.getFullYear()}`;
    dataPlanConGiorno.textContent = `${dataPlan.value} - ${getDayName(d)}`;
    updatePlanLists();
  });

  // Salvataggio pianificazione
  btnAddPlan.onclick = async () => {
    const d = dataPlan.value;
    const c = selectCantiere.value;
    const selectedPers = Array.from(selectPers.selectedOptions).map(o => o.value);
    const note = notePlan.value.trim();

    if(!d || !c || selectedPers.length === 0) {
      return alert('Seleziona data, cantiere e almeno un dipendente');
    }

    try {
      await salvaPianificazione({d,c,p:selectedPers,n:note});
      // Mantieni selezioni
      updatePlanLists();
      notePlan.value = '';
      renderPlan();
    } catch(e) {
      alert('Errore salvataggio pianificazione: ' + e.message);
    }
  };

  // Render tabella pianificazione
  function renderPlan() {
    // Lista date da mostrare: usiamo max 30 giorni intorno alla data attuale
    const oggi = new Date();
    const dates = [];
    for(let i=-15; i<=15; i++) {
      const d = new Date(oggi.getFullYear(), oggi.getMonth(), oggi.getDate()+i);
      dates.push(d.toISOString().slice(0,10));
    }

    // Costruiamo intestazione tabella con cantieri
    tablePlanHead.innerHTML = '<th>Data</th>';
    cantieri.forEach(c => {
      tablePlanHead.innerHTML += `<th>${c.nome}</th>`;
    });

    // Corpo tabella
    tablePlanBody.innerHTML = '';
    dates.forEach(data => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="date-cell">${data}</td>`;
      cantieri.forEach(c => {
        // Trova piani per questa data e cantiere
        const pianiFiltered = piani.filter(p => p.d === data && p.c === c.nome);
        if(pianiFiltered.length === 0) {
          tr.innerHTML += '<td></td>';
        } else {
          // Costruiamo lista dipendenti con nomi
          let list = '';
          pianiFiltered.forEach(p => {
            p.p.forEach(pid => {
              const pers = persone.find(pe => pe.id === pid);
              if(pers) list += pers.n + ' ' + pers.c + '<br>';
            });
          });
          tr.innerHTML += `<td>${list}</td>`;
        }
      });
      tablePlanBody.appendChild(tr);
    });

    // Aggiungi click per cancellare pianificazione
    tablePlanBody.querySelectorAll('td.date-cell').forEach(td => {
      td.style.cursor = 'pointer';
      td.title = 'Clicca per cancellare tutte le pianificazioni di questa data';
      td.onclick = async () => {
        if(confirm(`Sei sicuro di cancellare tutte le pianificazioni del giorno ${td.textContent}?`)) {
          const pianiDelGiorno = piani.filter(p => p.d === td.textContent);
          for(const p of pianiDelGiorno) {
            await cancellaPianificazione(p.id);
          }
        }
      };
    });
  }

  // Render annuale (versione base)
  const numWeekSelect = document.getElementById('numWeekSelect');
  const yearSelect = document.getElementById('yearSelect');
  const tableAnnual = document.getElementById('tableAnnual');
  const tableAnnualBody = tableAnnual.querySelector('tbody');
  const tableAnnualHead = tableAnnual.querySelector('thead tr');

  function renderAnnual() {
    const year = parseInt(yearSelect.value, 10);
    const week = parseInt(numWeekSelect.value, 10);

    // Calcola le date della settimana
    const dates = [];
    const simpleDate = new Date(year,0,1);
    // Correzione per primo giorno settimana (lunedì)
    let day = simpleDate.getDay();
    const offset = day <= 4 ? day - 1 : day - 8;
    let monday = new Date(simpleDate.getTime() - offset*86400000 + (week-1)*7*86400000);

    for(let i=0; i<7; i++) {
      const d = new Date(monday.getTime() + i*86400000);
      dates.push(d.toISOString().slice(0,10));
    }

    // Intestazione con date
    tableAnnualHead.innerHTML = '<th>Data</th>';
    cantieri.forEach(c => {
      tableAnnualHead.innerHTML += `<th>${c.nome}</th>`;
    });

    // Corpo tabella
    tableAnnualBody.innerHTML = '';
    dates.forEach(data => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${data}</td>`;
      cantieri.forEach(c => {
        const pianiFiltered = piani.filter(p => p.d === data && p.c === c.nome);
        if(pianiFiltered.length === 0) {
          tr.innerHTML += '<td></td>';
        } else {
          let list = '';
          pianiFiltered.forEach(p => {
            p.p.forEach(pid => {
              const pers = persone.find(pe => pe.id === pid);
              if(pers) list += pers.n + ' ' + pers.c + '<br>';
            });
          });
          tr.innerHTML += `<td>${list}</td>`;
        }
      });
      tableAnnualBody.appendChild(tr);
    });
  }

  numWeekSelect.addEventListener('input', renderAnnual);
  yearSelect.addEventListener('input', renderAnnual);

  // Tabs gestione
  tabs.forEach(tab => {
    tab.onclick = () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    };
  });

  // Inizializzazione
  caricaDati();

  // Quando si cambia filtro aggiorna le liste
  filterCantieri.addEventListener('input', renderCant);
  filterPersone.addEventListener('input', renderPers);

})();
</script>

</body>
</html>
